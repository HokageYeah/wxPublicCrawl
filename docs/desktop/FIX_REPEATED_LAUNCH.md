# ä¿®å¤è‡ªåŠ¨é‡å¤å¯åŠ¨é—®é¢˜

## é—®é¢˜æè¿°

åº”ç”¨å¯åŠ¨åï¼Œç¨‹åºä¼šè‡ªåŠ¨é‡å¤è§¦å‘å¯åŠ¨æµç¨‹ï¼Œå³ä½¿æ²¡æœ‰ç”¨æˆ·æ“ä½œï¼š

```
åº”ç”¨å·²å¯åŠ¨ï¼Œæ¬¢è¿ä½¿ç”¨ï¼
============================================================

(1ç§’åè‡ªåŠ¨è§¦å‘)
============================================================
å…¬ä¼—å·çˆ¬è™«åŠ©æ‰‹ - æ¡Œé¢ç‰ˆ
============================================================

[1/4] æ£€æŸ¥åº”ç”¨å®ä¾‹...
âš ï¸  æ£€æµ‹åˆ°åº”ç”¨å·²åœ¨è¿è¡Œ
```

## æ ¹æœ¬åŸå› 

**PyInstaller + å¤šçº¿ç¨‹/å¤šè¿›ç¨‹é—®é¢˜**ï¼š

å½“ä½¿ç”¨ PyInstaller æ‰“åŒ…åŒ…å«å¤šçº¿ç¨‹çš„åº”ç”¨æ—¶ï¼ˆuvicorn æœåŠ¡å™¨è¿è¡Œåœ¨åå°çº¿ç¨‹ï¼‰ï¼Œå¦‚æœæ²¡æœ‰æ­£ç¡®çš„ä¿æŠ¤ï¼š
- å­è¿›ç¨‹/çº¿ç¨‹å¯èƒ½ä¼šé‡æ–°å¯¼å…¥ä¸»æ¨¡å—
- å¯¼è‡´ `if __name__ == '__main__'` çš„ä»£ç è¢«å¤šæ¬¡æ‰§è¡Œ
- æ¯æ¬¡æ‰§è¡Œéƒ½ä¼šå°è¯•å¯åŠ¨ä¸€ä¸ªæ–°å®ä¾‹

è¿™æ˜¯ PyInstaller æ‰“åŒ…å¤šè¿›ç¨‹åº”ç”¨çš„ç»å…¸é—®é¢˜ã€‚

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. æ·»åŠ  multiprocessing.freeze_support()

è¿™æ˜¯ PyInstaller å®˜æ–¹æ¨èçš„ä¿®å¤æ–¹æ³•ï¼š

```python
import multiprocessing

# é˜²æ­¢å­è¿›ç¨‹é‡å¤æ‰§è¡Œä¸»ç¨‹åº
multiprocessing.freeze_support()
```

### 2. è®¾ç½®å¤šè¿›ç¨‹å¯åŠ¨æ–¹æ³•

å¯¹äº macOSï¼Œæ˜ç¡®è®¾ç½®ä¸º 'spawn' æ¨¡å¼ï¼š

```python
if platform.system() == 'Darwin':  # macOS
    try:
        multiprocessing.set_start_method('spawn', force=True)
    except RuntimeError:
        pass  # å·²ç»è®¾ç½®è¿‡äº†
```

### 3. ç¡®ä¿ if __name__ == '__main__' ä¿æŠ¤

æ‰€æœ‰å¯åŠ¨ä»£ç å¿…é¡»åœ¨è¿™ä¸ªä¿æŠ¤ä¸‹ï¼š

```python
if __name__ == '__main__':
    multiprocessing.set_start_method('spawn', force=True)
    main()
```

## ğŸ”§ å·²å®Œæˆçš„ä¿®æ”¹

æ–‡ä»¶ï¼š`run_desktop.py`

```python
import multiprocessing

# æ·»åŠ å†»ç»“æ”¯æŒï¼ˆåœ¨æ‰€æœ‰ä»£ç ä¹‹å‰ï¼‰
multiprocessing.freeze_support()

# ... å…¶ä»–ä»£ç  ...

if __name__ == '__main__':
    # è®¾ç½®å¯åŠ¨æ–¹æ³•
    if platform.system() == 'Darwin':
        try:
            multiprocessing.set_start_method('spawn', force=True)
        except RuntimeError:
            pass
    
    main()
```

## ğŸš€ é‡æ–°æ‰“åŒ…æµ‹è¯•

### æ­¥éª¤ 1: æ¸…ç†

```bash
cd "/Users/yuye/YeahWork/Pythoné¡¹ç›®/wxPublicCrawl"

# æ¸…ç†å®ä¾‹å’Œç«¯å£
./kill_app.sh

# åˆ é™¤æ—§æ‰“åŒ…æ–‡ä»¶
rm -rf dist build
```

### æ­¥éª¤ 2: é‡æ–°æ‰“åŒ…

```bash
./build_mac.sh
```

### æ­¥éª¤ 3: æµ‹è¯•

```bash
# å¯åŠ¨åº”ç”¨
./dist/WxPublicCrawler/WxPublicCrawler

# æˆ–
open dist/WxPublicCrawler.app
```

## âœ… é¢„æœŸç»“æœ

åº”è¯¥**åªçœ‹åˆ°ä¸€æ¬¡å¯åŠ¨æµç¨‹**ï¼š

```
============================================================
å…¬ä¼—å·çˆ¬è™«åŠ©æ‰‹ - æ¡Œé¢ç‰ˆ
============================================================

[1/4] æ£€æŸ¥åº”ç”¨å®ä¾‹...
âœ“  æ²¡æœ‰å…¶ä»–å®ä¾‹åœ¨è¿è¡Œ

[2/4] æ£€æŸ¥ç«¯å£å¯ç”¨æ€§...
âœ“  ç«¯å£ 18000 å¯ç”¨

[3/4] å¯åŠ¨åç«¯æœåŠ¡å™¨...
âœ“  æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ (http://127.0.0.1:18000)

[4/4] å¯åŠ¨åº”ç”¨çª—å£...
âœ“  åº”ç”¨çª—å£å·²åˆ›å»º

============================================================
åº”ç”¨å·²å¯åŠ¨ï¼Œæ¬¢è¿ä½¿ç”¨ï¼
============================================================

(ç„¶åæ˜¯æ­£å¸¸çš„ HTTP è¯·æ±‚æ—¥å¿—ï¼Œä¸ä¼šå†æœ‰é‡å¤å¯åŠ¨)
INFO:     127.0.0.1:xxxxx - "GET /crawl-desktop/ HTTP/1.1" 200 OK
INFO:     127.0.0.1:xxxxx - "GET /api/v1/... HTTP/1.1" 200 OK
```

**ä¸ä¼šå†å‡ºç°å¾ªç¯å¯åŠ¨çš„æç¤ºï¼**

## ğŸ“š æŠ€æœ¯è¯´æ˜

### multiprocessing.freeze_support()

è¿™ä¸ªå‡½æ•°åšäº†ä»€ä¹ˆï¼š
1. æ£€æµ‹å½“å‰æ˜¯å¦åœ¨å†»ç»“çš„ï¼ˆæ‰“åŒ…çš„ï¼‰å¯æ‰§è¡Œæ–‡ä»¶ä¸­è¿è¡Œ
2. å¦‚æœæ˜¯ï¼Œåˆ™è®¾ç½®ç‰¹æ®Šæ ‡å¿—ï¼Œé˜²æ­¢å­è¿›ç¨‹é‡æ–°æ‰§è¡Œä¸»ç¨‹åº
3. è¿™æ˜¯ PyInstaller æ‰“åŒ…åŒ…å«å¤šè¿›ç¨‹/å¤šçº¿ç¨‹ä»£ç çš„**å¿…éœ€æ­¥éª¤**

### ä¸ºä»€ä¹ˆä¹‹å‰æ²¡é—®é¢˜ï¼Ÿ

åœ¨å¼€å‘ç¯å¢ƒï¼ˆç›´æ¥è¿è¡Œ Python è„šæœ¬ï¼‰æ—¶ï¼š
- Python è§£é‡Šå™¨å¯ä»¥æ­£ç¡®å¤„ç†æ¨¡å—å¯¼å…¥
- `if __name__ == '__main__'` ä¿æŠ¤å·¥ä½œæ­£å¸¸

åœ¨ PyInstaller æ‰“åŒ…åï¼š
- æ•´ä¸ªåº”ç”¨å˜æˆä¸€ä¸ªå•ç‹¬çš„å¯æ‰§è¡Œæ–‡ä»¶
- å­è¿›ç¨‹å¯åŠ¨æ—¶ä¼šå°è¯•é‡æ–°åŠ è½½è¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶
- æ²¡æœ‰ `freeze_support()` ä¿æŠ¤ï¼Œå¯¼è‡´é‡å¤æ‰§è¡Œ

### ç±»ä¼¼é—®é¢˜çš„å…¶ä»–è¡¨ç°

- å¤šä¸ªåº”ç”¨çª—å£è‡ªåŠ¨æ‰“å¼€
- å¤šä¸ªåå°è¿›ç¨‹åŒæ—¶è¿è¡Œ
- ç«¯å£å†²çªï¼ˆåç»­å®ä¾‹æ— æ³•å¯åŠ¨ï¼‰
- CPU å ç”¨å¼‚å¸¸é«˜ï¼ˆå¤šä¸ªå®ä¾‹åŒæ—¶è¿è¡Œï¼‰

## ğŸ” è°ƒè¯•å»ºè®®

å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œå¯ä»¥æ·»åŠ è°ƒè¯•ä»£ç ï¼š

```python
if __name__ == '__main__':
    import sys
    print(f"ä¸»è¿›ç¨‹ PID: {os.getpid()}")
    print(f"sys.argv: {sys.argv}")
    print(f"sys.executable: {sys.executable}")
    
    # æ£€æŸ¥æ˜¯å¦æ˜¯å­è¿›ç¨‹
    if len(sys.argv) > 1 and '--multiprocessing-fork' in sys.argv:
        print("è¿™æ˜¯ä¸€ä¸ªå­è¿›ç¨‹ï¼Œä¸åº”è¯¥æ‰§è¡Œä¸»å‡½æ•°")
        sys.exit(0)
    
    main()
```

## ğŸ“– å‚è€ƒèµ„æ–™

- [PyInstaller - Multiprocessing](https://pyinstaller.org/en/stable/common-issues-and-pitfalls.html#multi-processing)
- [Python multiprocessing.freeze_support()](https://docs.python.org/3/library/multiprocessing.html#multiprocessing.freeze_support)

---

**ä¿®å¤æ—¶é—´**: 2025-12-20  
**é—®é¢˜**: åº”ç”¨è‡ªåŠ¨é‡å¤å¯åŠ¨  
**è§£å†³**: æ·»åŠ  multiprocessing å†»ç»“æ”¯æŒ

