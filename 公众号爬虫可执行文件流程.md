# 公众号爬虫桌面端程序设计与实现方案

## 1. 项目目标
将现有的 "微信公众号爬虫（基于微信官方接口）" 封装为一个独立运行的桌面可执行程序（.exe/.app）。程序启动后，用户可以通过图形界面完成：
1. 扫码登录微信公众号平台。
2. 搜索特定的公众号。
3. 查看公众号的文章列表。
4. 查看文章详情并下载保存到本地。

## 2. 技术架构
采用 **B/S 混合架构**（Browser/Server），利用 Python 的后端能力和 Web 前端的交互能力，通过 `pywebview` 进行封装。

*   **前端 (View)**: Vue 3 + TypeScript + TailwindCSS/UnoCSS (现有 `web` 目录)。
*   **后端 (Service)**: Python + FastAPI (现有 `app` 目录)。
*   **壳容器 (Container)**: `pywebview` (轻量级 Webview 容器，无需像 Electron 那样打包整个 Chromium)。
*   **打包工具 (Bundler)**: PyInstaller。

### 架构图
```mermaid
graph TD
    User[用户] --> |交互| GUI[桌面窗口 (PyWebView)]
    GUI --> |加载| WebApp[Vue3 前端应用]
    WebApp --> |HTTP请求| LocalServer[本地 Python FastAPI 服务]
    LocalServer --> |调用| WxAPI[wx_public.py 接口]
    WxAPI --> |HTTPS| WxServer[微信服务器]
    WxAPI --> |文件IO| LocalStorage[本地文件存储]
```

## 3. 详细流程设计

### 3.1 启动流程 (Startup)
1.  用户双击运行程序。
2.  **后端启动**:
    *   程序查找一个可用端口 (e.g., 18000)。
    *   在后台线程启动 FastAPI 服务 (Uvicorn)，监听该端口。
    *   服务配置静态文件挂载，指向 Vue 打包后的 `dist` 目录。
3.  **UI 启动**:
    *   使用 `pywebview.create_window` 创建窗口，标题为 "公众号爬虫助手"。
    *   窗口加载 `http://127.0.0.1:18000`。

### 3.2 业务流程 (Business Flow)

#### 阶段 1: 登录 (Login)
*   **UI**: 显示微信登录二维码 (复用现有的 `WeChatLogin.vue`，需微调)。
*   **API**:
    *   调用 `/api/v1/wx/login/get-wx-login-qrcode` 获取二维码。
    *   轮询 `/api/v1/wx/login/get-qrcode-status` 检查状态。
    *   登录成功后，后端保存 Cookies/Token。
*   **跳转**: 登录成功后，前端路由跳转至 "公众号搜索页"。

#### 阶段 2: 搜索与选择 (Search & Select)
*   **UI**: 搜索框输入 "公众号名称"。
*   **API**:
    *   调用 `/api/v1/wx/search-wx-public` (参数: query)。
*   **交互**: 展示搜索结果列表，用户点击某个公众号，记录 `fakeid` (wx_public_id)，跳转至 "文章列表页"。

#### 3.3 文章浏览与下载 (Browse & Download)
*   **UI**: 展示该公众号的历史文章列表 (分页)。
*   **API**:
    *   调用 `/api/v1/wx/get-wx-article-list`。
*   **下载**:
    *   用户点击 "查看/下载"，或者点击 "批量下载"。
    *   **选择保存路径**: 
        *   (可选) 前端通过 `window.pywebview.api.select_folder()` 调用 Python 原生文件选择框。
        *   或者默认保存到 `~/Downloads/WxArticles`。
    *   调用 `/api/v1/wx/get-wx-article-detail-by-link`。
    *   **后端逻辑增强**: 接收 `save_to_local_path`，下载图片/HTML，保存到本地。

## 4. 实现任务分解 (Implementation Tasks)

### 任务组 A: 后端适配 (Backend)
1.  **静态资源服务**:
    *   修改 `main.py` 或新建 `run_desktop.py`，增加 `StaticFiles` 挂载，将 `/` 映射到前端构建目录 `web/dist` ('index.html' 为默认页)。
2.  **API 增强**:
    *   确保 `get-wx-article-detail-by-link` 能够正确处理绝对路径保存。
    *   (可选) 增加一个 API `get-system-path` 或集成 `pywebview` JS API 以便前端获取用户 "下载目录"。

### 任务组 B: 前端开发 (Frontend)
1.  **路由配置 (Vue Router)**:
    *   增加 `router/index.ts`。
    *   定义路由: `/login` (WeChatLogin), `/search` (新), `/articles` (新)。
2.  **页面开发**:
    *   **Search.vue**: 搜索框 + 结果列表 (卡片式展示公众号头像、名称)。
    *   **ArticleList.vue**: 表格/列表展示文章标题、发布时间、阅读量。操作栏增加 "下载" 按钮。
3.  **API Client**:
    *   封装对 `/get-wx-article-list` 和 `/get-wx-article-detail-by-link` 的调用。

### 任务组 C: 桌面壳与入口 (Desktop Shell)
1.  **入口脚本 (`run_desktop.py`)**:
    *   编写启动脚本，集成 `uvicorn` 和 `webview`。
    *   实现关闭窗口同时也关闭服务器的逻辑。
2.  **JS <-> Python 桥接 (可选)**:
    *   如果需要原生文件选择对话框，需在 `webview.create_window` 中注册 Python API 对象。

### 任务组 D: 打包 (Packaging)
1.  **前端构建**: 运行 `npm run build` 生成 `dist`。
2.  **PyInstaller 配置**:
    *   编写 `wx_crawler.spec`。
    *   **关键点**: 将 `web/dist` 文件夹作为 `--add-data` 打包进 exe。
    *   处理 `uvicorn`, `fastapi`, `sqlalchemy` 等隐式导入问题。
3.  **构建**: `pyinstaller wx_crawler.spec`。

## 5. 目录结构规划 (New Structure)
```
wxPublicCrawl/
├── app/
│   ├── desktop/           # [NEW] 桌面端专用代码
│   │   ├── __init__.py
│   │   ├── main_window.py # PyWebview 窗口逻辑
│   │   └── api_bridge.py  # JS 桥接接口
│   └── ...
├── web/
│   ├── src/
│   │   ├── views/
│   │   │   ├── Search.vue      # [NEW]
│   │   │   ├── ArticleList.vue # [NEW]
│   │   └── ...
│   └── dist/              # [GEN] 前端构建产物
├── run_desktop.py         # [NEW] 桌面程序入口
└── wx_crawler.spec        # [NEW] 打包配置
```
