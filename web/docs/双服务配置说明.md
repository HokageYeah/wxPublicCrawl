# åŒæœåŠ¡é…ç½®è¯´æ˜

æœ¬é¡¹ç›®é…ç½®äº†ä¸¤ä¸ªåç«¯æœåŠ¡çš„å‰ç«¯è°ƒç”¨æ–¹æ¡ˆã€‚

---

## ğŸ“‹ é…ç½®æ¦‚è§ˆ

| æœåŠ¡ | ç«¯å£ | ä»£ç†å‰ç¼€ | ç”¨é€” |
|------|------|---------|------|
| **ä¸»åº”ç”¨æœåŠ¡** | 8002 | `/web-api` | å¾®ä¿¡å…¬ä¼—å·çˆ¬è™«ã€å–œé©¬æ‹‰é›…ç­‰ä¸»è¦åŠŸèƒ½ |
| **å¡å¯†æœåŠ¡** | 8003 | `/license-api/api/v1/` | ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€å¡å¯†ç»‘å®šå’Œæƒé™ç®¡ç† |

---

## ğŸ“ å·²ä¿®æ”¹çš„æ–‡ä»¶

### 1. ç¯å¢ƒå˜é‡é…ç½®

#### `.env.development`
```env
VITE_API_BASE_URL=/web-api/api/v1/wx/public
VITE_LICENSE_API_BASE_URL=/license-api/api/v1/
```

#### `.env.production`
```env
VITE_API_BASE_URL=/api/v1/wx/public
VITE_LICENSE_API_BASE_URL=http://127.0.0.1:8003/api/v1/
```

### 2. Vite é…ç½® (`vite.config.ts`)

æ·»åŠ äº†å¡å¯†æœåŠ¡çš„ä»£ç†é…ç½®ï¼š

```typescript
server: {
  proxy: {
    '/web-api': {
      target: 'http://127.0.0.1:8002',
      changeOrigin: true,
      rewrite: (path) => path.replace(/^\/web-api/, '')
    },
    '/license-api': {  // æ–°å¢
      target: 'http://127.0.0.1:8003',
      changeOrigin: true,
      rewrite: (path) => path.replace(/^\/license-api/, '')
    }
  }
}
```

### 3. Request å·¥å…·ç±» (`utils/request.ts`)

- å°† `Request` ç±»æ”¹ä¸ºå¯¼å‡ºç±»ï¼ˆ`export class Request`ï¼‰
- ä¿®æ”¹æ„é€ å‡½æ•°å‚æ•°ä¸ºå¯é€‰ï¼ˆ`config: AxiosRequestConfig = {}`ï¼‰
- ä½¿å…¶å¯è¢«ç»§æ‰¿å’Œå®ä¾‹åŒ–

---

## ğŸ†• æ–°å¢çš„æ–‡ä»¶

### 1. `utils/licenseRequest.ts`
å¡å¯†æœåŠ¡ä¸“ç”¨çš„ Request å®ä¾‹

```typescript
import { Request } from './request';

class LicenseRequest extends Request {
  constructor() {
    super({
      baseURL: import.meta.env.VITE_LICENSE_API_BASE_URL,
      timeout: 200000,
      withCredentials: true,
    });
  }
}

export default new LicenseRequest();
```

### 2. `services/licenseService.ts`
å¡å¯†æœåŠ¡çš„ API å°è£…ï¼ŒåŒ…å«ï¼š
- `register()` - ç”¨æˆ·æ³¨å†Œ
- `login()` - ç”¨æˆ·ç™»å½•
- `logout()` - ç”¨æˆ·ç™»å‡º
- `getUserInfo()` - è·å–ç”¨æˆ·ä¿¡æ¯
- `bindLicense()` - ç»‘å®šå¡å¯†
- `validateLicense()` - éªŒè¯å¡å¯†
- `getLicenseInfo()` - è·å–å¡å¯†ä¿¡æ¯
- `refreshToken()` - åˆ·æ–° Token

### 3. `stores/licenseStore.ts`
å¡å¯†æœåŠ¡çš„çŠ¶æ€ç®¡ç†ï¼ŒåŒ…å«ï¼š
- ç”¨æˆ·ä¿¡æ¯ï¼ˆ`userInfo`ï¼‰
- ç™»å½• Tokenï¼ˆ`token`ï¼‰
- ç™»å½•çŠ¶æ€ï¼ˆ`isLoggedIn`ï¼‰
- å¡å¯†çŠ¶æ€ï¼ˆ`licenseStatus`ï¼‰
- å„ç§çŠ¶æ€ç®¡ç†æ–¹æ³•

### 4. `docs/å¡å¯†æœåŠ¡é›†æˆæŒ‡å—.md`
è¯¦ç»†çš„é›†æˆæ–‡æ¡£ï¼ŒåŒ…å«ï¼š
- æ–‡ä»¶ç»“æ„è¯´æ˜
- ç¯å¢ƒé…ç½®
- API è°ƒç”¨æ–¹å¼
- çŠ¶æ€ç®¡ç†ä½¿ç”¨
- Vue ç»„ä»¶ç¤ºä¾‹
- è¯·æ±‚æ‹¦æˆªå™¨é…ç½®
- è°ƒè¯•æŠ€å·§

### 5. `docs/åŒæœåŠ¡é…ç½®è¯´æ˜.md`ï¼ˆæœ¬æ–‡ä»¶ï¼‰
é…ç½®æ€»ç»“å’Œä½¿ç”¨æŒ‡å—

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### å¼€å‘ç¯å¢ƒ

1. **å¯åŠ¨ä¸»åº”ç”¨æœåŠ¡**ï¼ˆç«¯å£ 8002ï¼‰
   ```bash
   python run_app.py
   ```

2. **å¯åŠ¨å¡å¯†æœåŠ¡**ï¼ˆç«¯å£ 8003ï¼‰
   ```bash
   # å‡è®¾ä½ çš„å¡å¯†æœåŠ¡å¯åŠ¨å‘½ä»¤æ˜¯è¿™æ ·çš„
   python run_license_server.py
   ```

3. **å¯åŠ¨å‰ç«¯å¼€å‘æœåŠ¡å™¨**
   ```bash
   cd web
   npm run dev
   ```

å‰ç«¯ä¼šé€šè¿‡ Vite ä»£ç†è‡ªåŠ¨è½¬å‘è¯·æ±‚ï¼š
- `/web-api/*` â†’ `http://127.0.0.1:8002/*`
- `/license-api/*` â†’ `http://127.0.0.1:8003/*`

### ç”Ÿäº§ç¯å¢ƒï¼ˆæ‰“åŒ…åï¼‰

1. **æ‰“åŒ…å‰ç«¯**
   ```bash
   cd web
   npm run build
   ```

2. **å¯åŠ¨ä¸¤ä¸ªåç«¯æœåŠ¡**
   - ä¸»åº”ç”¨æœåŠ¡ï¼š8002 ç«¯å£
   - å¡å¯†æœåŠ¡ï¼š8003 ç«¯å£

æ‰“åŒ…åçš„å‰ç«¯ä¼šï¼š
- ä¸»åº”ç”¨æœåŠ¡ï¼šé€šè¿‡ç›¸å¯¹è·¯å¾„è®¿é—®ï¼ˆå› ä¸ºå‰ç«¯åœ¨åŒä¸€æœåŠ¡å™¨ï¼‰
- å¡å¯†æœåŠ¡ï¼šç›´æ¥è®¿é—® `http://127.0.0.1:8003`

---

## ğŸ’¡ è°ƒç”¨ç¤ºä¾‹

### è°ƒç”¨ä¸»åº”ç”¨æœåŠ¡

```typescript
import request from '@/utils/request';
import { getWechatQRCode } from '@/services/wechatService';

// ä½¿ç”¨ service
const qrCode = await getWechatQRCode();

// ç›´æ¥ä½¿ç”¨ request
const data = await request.get('/some-endpoint');
```

### è°ƒç”¨å¡å¯†æœåŠ¡

```typescript
import licenseRequest from '@/utils/licenseRequest';
import { login, bindLicense } from '@/services/licenseService';
import { useLicenseStore } from '@/stores/licenseStore';

// ä½¿ç”¨ serviceï¼ˆæ¨èï¼‰
const result = await login({
  username: 'testuser',
  password: 'password123'
});

// ä½¿ç”¨ store
const licenseStore = useLicenseStore();
licenseStore.setToken(result.token);
licenseStore.setUserInfo(result.userInfo);

// ç»‘å®šå¡å¯†
await bindLicense({ licenseKey: 'XXXX-XXXX-XXXX-XXXX' });
```

---

## ğŸ” è¯·æ±‚æµç¨‹

### å¼€å‘ç¯å¢ƒ

```
å‰ç«¯é¡µé¢
  â†“
è°ƒç”¨ licenseRequest.get('/api/v1/user/info')
  â†“
å®é™…è¯·æ±‚: GET /license-api/api/v1/user/info
  â†“
Vite ä»£ç†è½¬å‘åˆ°: http://127.0.0.1:8003/api/v1/user/info
  â†“
å¡å¯†æœåŠ¡å¤„ç†å¹¶è¿”å›
```

### ç”Ÿäº§ç¯å¢ƒ

```
å‰ç«¯é¡µé¢
  â†“
è°ƒç”¨ licenseRequest.get('/api/v1/user/info')
  â†“
å®é™…è¯·æ±‚: GET http://127.0.0.1:8003/api/v1/user/info
  â†“
å¡å¯†æœåŠ¡å¤„ç†å¹¶è¿”å›
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ç«¯å£å ç”¨**ï¼šç¡®ä¿ 8002 å’Œ 8003 ç«¯å£æœªè¢«å ç”¨
2. **CORS é…ç½®**ï¼šå¦‚æœåœ¨ç”Ÿäº§ç¯å¢ƒé‡åˆ°è·¨åŸŸé—®é¢˜ï¼Œéœ€è¦åœ¨åç«¯é…ç½® CORS
3. **Token ç®¡ç†**ï¼šå¡å¯†æœåŠ¡çš„ Token ä¿å­˜åœ¨ `localStorage` ä¸­
4. **é”™è¯¯å¤„ç†**ï¼šä¸¤ä¸ªæœåŠ¡çš„é”™è¯¯æ ¼å¼å¯èƒ½ä¸åŒï¼Œéœ€è¦åˆ†åˆ«å¤„ç†
5. **ç¯å¢ƒå˜é‡**ï¼šä¿®æ”¹ `.env.*` æ–‡ä»¶åéœ€è¦é‡å¯å¼€å‘æœåŠ¡å™¨

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [API æ¥å£é€ŸæŸ¥è¡¨](./APIæ¥å£é€ŸæŸ¥è¡¨.md) - å¡å¯†æœåŠ¡çš„ API æ–‡æ¡£
- [å¡å¯†æœåŠ¡é›†æˆæŒ‡å—](./å¡å¯†æœåŠ¡é›†æˆæŒ‡å—.md) - è¯¦ç»†çš„é›†æˆä½¿ç”¨æŒ‡å—

---

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### é—®é¢˜1: è¯·æ±‚ 404

**åŸå› **: ä»£ç†é…ç½®ä¸æ­£ç¡®æˆ–åç«¯æœåŠ¡æœªå¯åŠ¨

**è§£å†³**:
1. æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œåœ¨æ­£ç¡®çš„ç«¯å£
2. æ£€æŸ¥ `vite.config.ts` ä¸­çš„ä»£ç†é…ç½®
3. æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®

### é—®é¢˜2: CORS é”™è¯¯

**åŸå› **: ç”Ÿäº§ç¯å¢ƒä¸‹çš„è·¨åŸŸé—®é¢˜

**è§£å†³**:
åœ¨åç«¯æœåŠ¡ï¼ˆ8003ï¼‰æ·»åŠ  CORS é…ç½®ï¼š
```python
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://127.0.0.1:8002"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

### é—®é¢˜3: Token ä¸¢å¤±

**åŸå› **: localStorage è¢«æ¸…ç©ºæˆ–è¿‡æœŸ

**è§£å†³**:
```typescript
const licenseStore = useLicenseStore();
licenseStore.restoreToken();  // æ‰‹åŠ¨æ¢å¤ Token
```

---

**åˆ›å»ºæ—¶é—´**: 2026-02-02
**ç»´æŠ¤äººå‘˜**: å¼€å‘å›¢é˜Ÿ
