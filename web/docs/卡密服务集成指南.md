# å¡å¯†æœåŠ¡é›†æˆæŒ‡å—

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•åœ¨å‰ç«¯é¡¹ç›®ä¸­é›†æˆå’Œä½¿ç”¨å¡å¯†ç»‘å®šæœåŠ¡ã€‚

---

## ğŸ“ æ–‡ä»¶ç»“æ„

```
web/src/
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ request.ts              # ä¸»åº”ç”¨æœåŠ¡è¯·æ±‚å®ä¾‹ï¼ˆ8002ç«¯å£ï¼‰
â”‚   â””â”€â”€ licenseRequest.ts       # å¡å¯†æœåŠ¡è¯·æ±‚å®ä¾‹ï¼ˆ8003ç«¯å£ï¼‰
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ wechatService.ts        # å¾®ä¿¡æœåŠ¡ API
â”‚   â”œâ”€â”€ xmlyService.ts          # å–œé©¬æ‹‰é›…æœåŠ¡ API
â”‚   â””â”€â”€ licenseService.ts       # å¡å¯†æœåŠ¡ API â­æ–°å¢
â”œâ”€â”€ stores/
â”‚   â”œâ”€â”€ wechatLoginStore.ts     # å¾®ä¿¡ç™»å½•çŠ¶æ€
â”‚   â”œâ”€â”€ xmlyLoginStore.ts       # å–œé©¬æ‹‰é›…ç™»å½•çŠ¶æ€
â”‚   â””â”€â”€ licenseStore.ts         # å¡å¯†æœåŠ¡çŠ¶æ€ â­æ–°å¢
â””â”€â”€ views/
    â””â”€â”€ LicenseLogin.vue        # å¡å¯†ç™»å½•é¡µé¢ï¼ˆç¤ºä¾‹ï¼‰
```

---

## âš™ï¸ ç¯å¢ƒé…ç½®

### å¼€å‘ç¯å¢ƒ (`.env.development`)
```env
# ä¸»åº”ç”¨æœåŠ¡ï¼ˆå¾®ä¿¡å…¬ä¼—å·çˆ¬è™«ç­‰ï¼‰
VITE_API_BASE_URL=/web-api/api/v1/wx/public

# å¡å¯†ç»‘å®šæœåŠ¡
VITE_LICENSE_API_BASE_URL=/license-api/api/v1/
```

### ç”Ÿäº§ç¯å¢ƒ (`.env.production`)
```env
# ä¸»åº”ç”¨æœåŠ¡
VITE_API_BASE_URL=/api/v1/wx/public

# å¡å¯†ç»‘å®šæœåŠ¡ï¼ˆæ‰“åŒ…åç›´æ¥è®¿é—®ï¼‰
VITE_LICENSE_API_BASE_URL=http://127.0.0.1:8003/api/v1/
```

### Vite ä»£ç†é…ç½® (`vite.config.ts`)
```typescript
server: {
  proxy: {
    // ä¸»åº”ç”¨æœåŠ¡ä»£ç†
    '/web-api': {
      target: 'http://127.0.0.1:8002',
      changeOrigin: true,
      rewrite: (path) => path.replace(/^\/web-api/, '')
    },
    // å¡å¯†æœåŠ¡ä»£ç†
    '/license-api': {
      target: 'http://127.0.0.1:8003',
      changeOrigin: true,
      rewrite: (path) => path.replace(/^\/license-api/, '')
    }
  }
}
```

---

## ğŸ”Œ API è°ƒç”¨æ–¹å¼

### 1. ä½¿ç”¨ Service å±‚ï¼ˆæ¨èï¼‰

```typescript
import { login, register, bindLicense, getUserInfo } from '@/services/licenseService';

// ç™»å½•
const loginResult = await login({
  username: 'testuser',
  password: 'password123'
});

// æ³¨å†Œ
const registerResult = await register({
  username: 'newuser',
  password: 'password123',
  email: 'user@example.com'
});

// ç»‘å®šå¡å¯†
await bindLicense({
  licenseKey: 'XXXX-XXXX-XXXX-XXXX'
});

// è·å–ç”¨æˆ·ä¿¡æ¯
const userInfo = await getUserInfo();
```

### 2. ç›´æ¥ä½¿ç”¨ Request å®ä¾‹

```typescript
import licenseRequest from '@/utils/licenseRequest';

// GET è¯·æ±‚
const data = await licenseRequest.get('/api/v1/user/info');

// POST è¯·æ±‚
const result = await licenseRequest.post('/api/v1/auth/login', {
  username: 'user',
  password: 'pass'
});

// è®¾ç½®è‡ªå®šä¹‰è¯·æ±‚å¤´
licenseRequest.addCustomHeaderGetter(() => ({
  key: 'X-Custom-Header',
  value: 'custom-value'
}));
```

---

## ğŸ’¾ çŠ¶æ€ç®¡ç†

### ä½¿ç”¨ Pinia Store

```typescript
import { useLicenseStore } from '@/stores/licenseStore';

const licenseStore = useLicenseStore();

// è®¾ç½®ç”¨æˆ·ä¿¡æ¯
licenseStore.setUserInfo({
  id: '123',
  username: 'testuser',
  licenseStatus: 'active'
});

// è®¾ç½® Token
licenseStore.setToken('your-jwt-token');

// è¯»å–çŠ¶æ€
console.log(licenseStore.isLoggedIn);      // æ˜¯å¦ç™»å½•
console.log(licenseStore.userInfo);        // ç”¨æˆ·ä¿¡æ¯
console.log(licenseStore.licenseStatus);   // å¡å¯†çŠ¶æ€

// æ¸…é™¤çŠ¶æ€ï¼ˆç™»å‡ºï¼‰
licenseStore.clearUserInfo();
```

---

## ğŸ¨ Vue ç»„ä»¶ç¤ºä¾‹

### ç™»å½•ç»„ä»¶

```vue
<template>
  <div class="license-login">
    <h2>ç”¨æˆ·ç™»å½•</h2>
    <form @submit.prevent="handleLogin">
      <input 
        v-model="username" 
        type="text" 
        placeholder="ç”¨æˆ·å"
        required
      />
      <input 
        v-model="password" 
        type="password" 
        placeholder="å¯†ç "
        required
      />
      <button type="submit" :disabled="loading">
        {{ loading ? 'ç™»å½•ä¸­...' : 'ç™»å½•' }}
      </button>
    </form>
    
    <div v-if="error" class="error">{{ error }}</div>
    
    <div v-if="licenseStore.isLoggedIn" class="user-info">
      <p>æ¬¢è¿ï¼Œ{{ licenseStore.userInfo?.username }}</p>
      <p>å¡å¯†çŠ¶æ€ï¼š{{ licenseStore.licenseStatus }}</p>
      <button @click="handleLogout">ç™»å‡º</button>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue';
import { login, logout } from '@/services/licenseService';
import { useLicenseStore } from '@/stores/licenseStore';
import { showToast } from '@/utils/toast';

const licenseStore = useLicenseStore();
const username = ref('');
const password = ref('');
const loading = ref(false);
const error = ref('');

// ç™»å½•å¤„ç†
const handleLogin = async () => {
  loading.value = true;
  error.value = '';
  
  try {
    const result = await login({
      username: username.value,
      password: password.value
    });
    
    // ä¿å­˜ç™»å½•çŠ¶æ€
    licenseStore.setToken(result.token);
    licenseStore.setUserInfo(result.userInfo);
    
    showToast('ç™»å½•æˆåŠŸï¼', 'success');
  } catch (err: any) {
    error.value = err.message || 'ç™»å½•å¤±è´¥';
    showToast(error.value, 'error');
  } finally {
    loading.value = false;
  }
};

// ç™»å‡ºå¤„ç†
const handleLogout = async () => {
  try {
    await logout();
    licenseStore.clearUserInfo();
    showToast('å·²ç™»å‡º', 'success');
  } catch (err: any) {
    showToast('ç™»å‡ºå¤±è´¥ï¼š' + err.message, 'error');
  }
};
</script>

<style scoped>
.license-login {
  max-width: 400px;
  margin: 0 auto;
  padding: 20px;
}

input {
  width: 100%;
  padding: 10px;
  margin-bottom: 10px;
  border: 1px solid #ddd;
  border-radius: 4px;
}

button {
  width: 100%;
  padding: 10px;
  background: #42b983;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

button:disabled {
  background: #ccc;
  cursor: not-allowed;
}

.error {
  color: red;
  margin-top: 10px;
}

.user-info {
  margin-top: 20px;
  padding: 15px;
  background: #f5f5f5;
  border-radius: 4px;
}
</style>
```

### å¡å¯†ç»‘å®šç»„ä»¶

```vue
<template>
  <div class="license-bind">
    <h2>ç»‘å®šå¡å¯†</h2>
    <form @submit.prevent="handleBind">
      <input 
        v-model="licenseKey" 
        type="text" 
        placeholder="è¯·è¾“å…¥å¡å¯†ï¼ˆæ ¼å¼ï¼šXXXX-XXXX-XXXX-XXXXï¼‰"
        required
      />
      <button type="submit" :disabled="loading">
        {{ loading ? 'ç»‘å®šä¸­...' : 'ç»‘å®šå¡å¯†' }}
      </button>
    </form>
    
    <div v-if="message" :class="messageType">{{ message }}</div>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue';
import { bindLicense } from '@/services/licenseService';
import { useLicenseStore } from '@/stores/licenseStore';
import { showToast } from '@/utils/toast';

const licenseStore = useLicenseStore();
const licenseKey = ref('');
const loading = ref(false);
const message = ref('');
const messageType = ref('');

const handleBind = async () => {
  if (!licenseStore.isLoggedIn) {
    message.value = 'è¯·å…ˆç™»å½•';
    messageType.value = 'error';
    return;
  }
  
  loading.value = true;
  message.value = '';
  
  try {
    await bindLicense({ licenseKey: licenseKey.value });
    
    message.value = 'å¡å¯†ç»‘å®šæˆåŠŸï¼';
    messageType.value = 'success';
    licenseKey.value = '';
    
    showToast('å¡å¯†ç»‘å®šæˆåŠŸ', 'success');
  } catch (err: any) {
    message.value = err.message || 'ç»‘å®šå¤±è´¥';
    messageType.value = 'error';
    showToast(message.value, 'error');
  } finally {
    loading.value = false;
  }
};
</script>

<style scoped>
.license-bind {
  max-width: 400px;
  margin: 20px auto;
  padding: 20px;
}

.error {
  color: red;
  margin-top: 10px;
}

.success {
  color: green;
  margin-top: 10px;
}
</style>
```

---

## ğŸ”„ è¯·æ±‚æ‹¦æˆªå™¨

### è‡ªåŠ¨æ·»åŠ  Token

```typescript
// åœ¨ licenseRequest.ts æˆ–åº”ç”¨åˆå§‹åŒ–æ—¶æ·»åŠ 
import licenseRequest from '@/utils/licenseRequest';
import { useLicenseStore } from '@/stores/licenseStore';

// æ·»åŠ  Token åˆ°è¯·æ±‚å¤´
licenseRequest.addCustomHeaderGetter(() => {
  const licenseStore = useLicenseStore();
  return {
    key: 'Authorization',
    value: `Bearer ${licenseStore.token}`
  };
});
```

### å¤„ç† Token è¿‡æœŸ

```typescript
import { refreshToken } from '@/services/licenseService';
import { useLicenseStore } from '@/stores/licenseStore';

// åœ¨å“åº”æ‹¦æˆªå™¨ä¸­å¤„ç† 401 é”™è¯¯
licenseRequest.instance.interceptors.response.use(
  response => response,
  async error => {
    if (error.response?.status === 401) {
      const licenseStore = useLicenseStore();
      
      try {
        // å°è¯•åˆ·æ–° Token
        const { token } = await refreshToken();
        licenseStore.setToken(token);
        
        // é‡è¯•åŸè¯·æ±‚
        return licenseRequest.request(error.config);
      } catch {
        // åˆ·æ–°å¤±è´¥ï¼Œæ¸…é™¤ç™»å½•çŠ¶æ€
        licenseStore.clearUserInfo();
        // è·³è½¬åˆ°ç™»å½•é¡µ
        window.location.href = '/login';
      }
    }
    
    return Promise.reject(error);
  }
);
```

---

## ğŸš€ è·¯ç”±é…ç½®

```typescript
// src/router/modules/license.ts
export default [
  {
    path: '/license',
    name: 'License',
    children: [
      {
        path: 'login',
        name: 'LicenseLogin',
        component: () => import('@/views/LicenseLogin.vue')
      },
      {
        path: 'register',
        name: 'LicenseRegister',
        component: () => import('@/views/LicenseRegister.vue')
      },
      {
        path: 'bind',
        name: 'LicenseBind',
        component: () => import('@/views/LicenseBind.vue'),
        meta: { requiresAuth: true }  // éœ€è¦ç™»å½•
      }
    ]
  }
];
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **å¼€å‘ç¯å¢ƒ**ï¼šä½¿ç”¨ä»£ç† `/license-api`ï¼ŒVite ä¼šè‡ªåŠ¨è½¬å‘åˆ° `http://127.0.0.1:8003`
2. **ç”Ÿäº§ç¯å¢ƒï¼ˆæ‰“åŒ…åï¼‰**ï¼šç›´æ¥è®¿é—® `http://127.0.0.1:8003`ï¼Œæ— éœ€ä»£ç†
3. **Token ç®¡ç†**ï¼šToken ä¿å­˜åœ¨ `localStorage` ä¸­ï¼Œé¡µé¢åˆ·æ–°åä¼šè‡ªåŠ¨æ¢å¤
4. **é”™è¯¯å¤„ç†**ï¼šæ‰€æœ‰ API è°ƒç”¨éƒ½åº”è¯¥ç”¨ `try-catch` åŒ…è£¹
5. **ç±»å‹å®‰å…¨**ï¼šä½¿ç”¨ TypeScript ç±»å‹å®šä¹‰ç¡®ä¿ç±»å‹å®‰å…¨

---

## ğŸ” è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹è¯·æ±‚è¯¦æƒ…

```typescript
// å¼€å¯ licenseRequest çš„æ—¥å¿—
console.log('å¡å¯†æœåŠ¡ API åŸºç¡€è·¯å¾„:', import.meta.env.VITE_LICENSE_API_BASE_URL);

// æŸ¥çœ‹ Store çŠ¶æ€
import { useLicenseStore } from '@/stores/licenseStore';
const licenseStore = useLicenseStore();
console.log('License Store:', licenseStore.$state);
```

### æµ‹è¯• API

åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­ï¼š

```javascript
// æµ‹è¯•ç™»å½•
const { login } = await import('@/services/licenseService');
const result = await login({ username: 'test', password: 'test123' });
console.log(result);

// æµ‹è¯•è·å–ç”¨æˆ·ä¿¡æ¯
const { getUserInfo } = await import('@/services/licenseService');
const userInfo = await getUserInfo();
console.log(userInfo);
```

---

**æœ€åæ›´æ–°**: 2026-02-02
