# -*- mode: python ; coding: utf-8 -*-
# ============================================================================
# PyInstaller é…ç½®æ–‡ä»¶
# ç”¨é€”ï¼šå°† Python æ¡Œé¢åº”ç”¨æ‰“åŒ…ä¸ºç‹¬ç«‹å¯æ‰§è¡Œæ–‡ä»¶
# å¹³å°ï¼šmacOS (.app) / Windows (.exe)
# ============================================================================

import sys
import os
import platform

# åŠ å¯†é…ç½®ï¼ˆNone = ä¸åŠ å¯†ï¼‰
block_cipher = None

# ============================================================================
# å¹³å°æ£€æµ‹
# ============================================================================
is_mac = platform.system() == 'Darwin'       # macOS
is_windows = platform.system() == 'Windows'  # Windows

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ° Python è·¯å¾„ï¼ˆç¡®ä¿èƒ½æ‰¾åˆ° app æ¨¡å—ï¼‰
sys.path.insert(0, os.path.abspath('.'))

# ============================================================================
# Analysis é˜¶æ®µï¼šåˆ†æä¾èµ–å…³ç³»
# ============================================================================
a = Analysis(
    # --------------------------------------------------------------------
    # å…¥å£è„šæœ¬ï¼šåº”ç”¨çš„ä¸»å…¥å£æ–‡ä»¶
    # --------------------------------------------------------------------
    ['run_desktop.py'],
    
    # --------------------------------------------------------------------
    # pathexï¼šé¢å¤–çš„æœç´¢è·¯å¾„ï¼ˆå·²é€šè¿‡ sys.path æ·»åŠ ï¼Œè¿™é‡Œç•™ç©ºï¼‰
    # --------------------------------------------------------------------
    pathex=[],
    
    # --------------------------------------------------------------------
    # binariesï¼šéœ€è¦æ‰“åŒ…çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆå¦‚ .dllã€.soã€.dylibï¼‰
    # æ ¼å¼ï¼š[('æºè·¯å¾„', 'ç›®æ ‡è·¯å¾„')]
    # --------------------------------------------------------------------
    binaries=[],
    
    # --------------------------------------------------------------------
    # datasï¼šéœ€è¦æ‰“åŒ…çš„æ•°æ®æ–‡ä»¶ï¼ˆéä»£ç æ–‡ä»¶ï¼‰
    # æ ¼å¼ï¼š[('æºè·¯å¾„', 'ç›®æ ‡è·¯å¾„')]
    # --------------------------------------------------------------------
    datas=[
        ('web/dist', 'web/dist'),  # Vue3 å‰ç«¯æ„å»ºäº§ç‰©ï¼ˆHTML/CSS/JSï¼‰
        ('app/ai/prompt', 'app/ai/prompt'),  # AI æç¤ºè¯æ–‡ä»¶
        ('app/ai/mcp/mcp_client/mcp_settings.json', 'app/ai/mcp/mcp_client'),  # MCP è®¾ç½®æ–‡ä»¶
        ('.env', '.'),  # æ‰“åŒ… .env æ–‡ä»¶åˆ°æ ¹ç›®å½•
        ('.env.desktop', '.'),  # æ‰“åŒ… .env.desktop æ–‡ä»¶åˆ°æ ¹ç›®å½•
        # å¦‚æœæœ‰å…¶ä»–èµ„æºæ–‡ä»¶ï¼Œåœ¨æ­¤æ·»åŠ ï¼š
        # ('resources/images', 'resources/images'),
        # ('config/default.yaml', 'config'),
    ],
    
    # --------------------------------------------------------------------
    # hiddenimportsï¼šéšå¼å¯¼å…¥çš„æ¨¡å—
    # PyInstaller æ— æ³•è‡ªåŠ¨æ£€æµ‹çš„åŠ¨æ€å¯¼å…¥æ¨¡å—éœ€æ‰‹åŠ¨å£°æ˜
    # --------------------------------------------------------------------
    hiddenimports=[
        # Uvicorn ç›¸å…³ï¼ˆFastAPI æœåŠ¡å™¨ï¼‰
        'uvicorn.logging',
        'uvicorn.loops',
        'uvicorn.loops.auto',
        'uvicorn.protocols',
        'uvicorn.protocols.http',
        'uvicorn.protocols.http.auto',
        'uvicorn.protocols.websockets',
        'uvicorn.protocols.websockets.auto',
        'uvicorn.lifespan',
        'uvicorn.lifespan.on',
        
        # æ•°æ®åº“ç›¸å…³ï¼ˆSQLAlchemy + SQLiteï¼‰
        'sqlalchemy.sql.default_comparator',
        'pysqlite3',  # SQLite æ•°æ®åº“é©±åŠ¨
        
        # é¡¹ç›®ä¸šåŠ¡æ¨¡å—ï¼ˆåŠ¨æ€å¯¼å…¥çš„æœåŠ¡å’Œæ¥å£ï¼‰
        'app.services.wx_public',       # å¾®ä¿¡å…¬ä¼—å·æœåŠ¡
        'app.services.sogou_wx_public',  # æœç‹—æœç´¢æœåŠ¡
        'app.services.system',           # ç³»ç»ŸæœåŠ¡
        'app.api.endpoints.wx_public',   # å¾®ä¿¡å…¬ä¼—å· API
        'app.api.endpoints.sogou_wx_public',  # æœç‹—æœç´¢ API
        'app.api.endpoints.system',      # ç³»ç»Ÿ API
        
        # å…¶ä»–å¿…è¦æ¨¡å—
        'pkg_resources.py2_warn',
    ],
    
    # --------------------------------------------------------------------
    # hookspathï¼šè‡ªå®šä¹‰ hook è„šæœ¬çš„è·¯å¾„ï¼ˆç”¨äºç‰¹æ®Šæ‰“åŒ…éœ€æ±‚ï¼‰
    # --------------------------------------------------------------------
    hookspath=[],
    
    # --------------------------------------------------------------------
    # hooksconfigï¼šhook é…ç½®
    # --------------------------------------------------------------------
    hooksconfig={},
    
    # --------------------------------------------------------------------
    # runtime_hooksï¼šè¿è¡Œæ—¶ hookï¼ˆåœ¨åº”ç”¨å¯åŠ¨å‰æ‰§è¡Œçš„è„šæœ¬ï¼‰
    # --------------------------------------------------------------------
    runtime_hooks=[],
    
    # --------------------------------------------------------------------
    # excludesï¼šæ’é™¤çš„æ¨¡å—ï¼ˆå‡å°æ‰“åŒ…ä½“ç§¯ï¼‰
    # è¿™äº›æ¨¡å—ä¸ä¼šè¢«æ‰“åŒ…ï¼Œç¡®ä¿åº”ç”¨ä¸ä¾èµ–å®ƒä»¬
    # --------------------------------------------------------------------
    excludes=[
        'matplotlib',  # å›¾è¡¨åº“ï¼ˆæœªä½¿ç”¨ï¼‰
        'PIL',         # å›¾åƒå¤„ç†åº“ï¼ˆæœªä½¿ç”¨ï¼‰
        'PyQt5',       # Qt æ¡†æ¶ï¼ˆæœªä½¿ç”¨ï¼‰
        'tkinter',     # Tk GUI åº“ï¼ˆæœªä½¿ç”¨ï¼‰
        'test',        # æµ‹è¯•æ¨¡å—
        'unittest',    # å•å…ƒæµ‹è¯•
        'mysql.connector.plugins',  # MySQL æ’ä»¶ï¼ˆæ¡Œé¢ç‰ˆç”¨ SQLiteï¼‰
        'pymysql',     # MySQL é©±åŠ¨ï¼ˆæ¡Œé¢ç‰ˆç”¨ SQLiteï¼‰
    ],
    
    # --------------------------------------------------------------------
    # Windows ç‰¹å®šé…ç½®
    # --------------------------------------------------------------------
    win_no_prefer_redirects=False,   # ä¸ä½¿ç”¨é‡å®šå‘
    win_private_assemblies=False,    # ä¸ä½¿ç”¨ç§æœ‰ç¨‹åºé›†
    
    # --------------------------------------------------------------------
    # åŠ å¯†é…ç½®
    # --------------------------------------------------------------------
    cipher=block_cipher,  # å­—èŠ‚ç åŠ å¯†ï¼ˆNone = ä¸åŠ å¯†ï¼‰
    
    # --------------------------------------------------------------------
    # å½’æ¡£é…ç½®
    # --------------------------------------------------------------------
    noarchive=False,  # å…è®¸å°† Python æ¨¡å—å½’æ¡£ä¸º PYZ
)

# ============================================================================
# PYZ é˜¶æ®µï¼šåˆ›å»º Python å½’æ¡£æ–‡ä»¶
# å°†æ‰€æœ‰ Python æ¨¡å—å‹ç¼©ä¸ºä¸€ä¸ª .pyz æ–‡ä»¶
# ============================================================================
pyz = PYZ(
    a.pure,          # çº¯ Python æ¨¡å—
    a.zipped_data,   # å‹ç¼©æ•°æ®
    cipher=block_cipher  # åŠ å¯†é…ç½®
)

# ============================================================================
# EXE é˜¶æ®µï¼šåˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶
# ============================================================================
exe = EXE(
    pyz,           # Python å½’æ¡£æ–‡ä»¶
    a.scripts,     # è„šæœ¬æ–‡ä»¶
    [],            # é¢å¤–çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆç©º = ä½¿ç”¨ COLLECTï¼‰
    
    # --------------------------------------------------------------------
    # åŸºæœ¬é…ç½®
    # --------------------------------------------------------------------
    exclude_binaries=True,  # ä¸å°†äºŒè¿›åˆ¶æ–‡ä»¶æ‰“åŒ…åˆ° EXEï¼ˆä½¿ç”¨ COLLECTï¼‰
    name='wxå…¬ä¼—å·å·¥å…·', # å¯æ‰§è¡Œæ–‡ä»¶åç§°
    
    # --------------------------------------------------------------------
    # è°ƒè¯•å’Œä¼˜åŒ–
    # --------------------------------------------------------------------
    debug=False,     # ä¸å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
    strip=False,     # ä¸å‰¥ç¦»ç¬¦å·ï¼ˆä¿ç•™è°ƒè¯•ä¿¡æ¯ï¼‰
    upx=True,        # ä½¿ç”¨ UPX å‹ç¼©ï¼ˆå‡å°ä½“ç§¯ï¼‰
    
    # --------------------------------------------------------------------
    # è¿è¡Œæ¨¡å¼
    # --------------------------------------------------------------------
    console=True,    # æ˜¾ç¤ºæ§åˆ¶å°çª—å£ï¼ˆè°ƒè¯•ç”¨ï¼‰
                     # æ”¹ä¸º False åˆ™éšè—æ§åˆ¶å°ï¼ˆçº¯ GUI æ¨¡å¼ï¼‰
    
    # --------------------------------------------------------------------
    # ğŸ¨ åº”ç”¨å›¾æ ‡é…ç½®ï¼ˆåœ¨æ­¤æ·»åŠ å›¾æ ‡ï¼‰
    # --------------------------------------------------------------------
    icon='resources/icon.icns',  # macOS å›¾æ ‡ï¼ˆ.icns æ ¼å¼ï¼‰
    # icon='resources/icon.ico',   # Windows å›¾æ ‡ï¼ˆ.ico æ ¼å¼ï¼‰
    # ä½¿ç”¨æ–¹æ³•ï¼š
    # 1. å‡†å¤‡å›¾æ ‡æ–‡ä»¶
    #    - macOS: icon.icns (æ¨è 512x512)
    #    - Windows: icon.ico (åŒ…å«å¤šä¸ªå°ºå¯¸ï¼š16x16, 32x32, 48x48, 256x256)
    # 2. æ”¾ç½®åœ¨ resources/ ç›®å½•
    # 3. å–æ¶ˆä¸Šé¢å¯¹åº”å¹³å°çš„æ³¨é‡Š
    
    # --------------------------------------------------------------------
    # macOS ç‰¹å®šé…ç½®
    # --------------------------------------------------------------------
    bootloader_ignore_signals=False,  # ä¸å¿½ç•¥ä¿¡å·
    argv_emulation=False,             # ä¸æ¨¡æ‹Ÿ argvï¼ˆmacOSï¼‰
    
    # --------------------------------------------------------------------
    # Windows ç‰¹å®šé…ç½®
    # --------------------------------------------------------------------
    disable_windowed_traceback=False,  # ä¸ç¦ç”¨çª—å£æ¨¡å¼çš„ traceback
    
    # --------------------------------------------------------------------
    # æ¶æ„å’Œç­¾å
    # --------------------------------------------------------------------
    target_arch=None,          # ç›®æ ‡æ¶æ„ï¼ˆNone = è‡ªåŠ¨æ£€æµ‹ï¼‰
    codesign_identity=None,    # macOS ä»£ç ç­¾åèº«ä»½ï¼ˆNone = ä¸ç­¾åï¼‰
    entitlements_file=None,    # macOS æƒé™æ–‡ä»¶ï¼ˆNone = æ— ï¼‰
)

# ============================================================================
# COLLECT é˜¶æ®µï¼šæ”¶é›†æ‰€æœ‰æ–‡ä»¶
# å°†å¯æ‰§è¡Œæ–‡ä»¶ã€ä¾èµ–åº“ã€èµ„æºæ–‡ä»¶æ‰“åŒ…åˆ°ä¸€ä¸ªç›®å½•
# ============================================================================
coll = COLLECT(
    exe,           # å¯æ‰§è¡Œæ–‡ä»¶
    a.binaries,    # äºŒè¿›åˆ¶ä¾èµ–ï¼ˆ.dll/.so/.dylibï¼‰
    a.zipfiles,    # ZIP æ–‡ä»¶
    a.datas,       # æ•°æ®æ–‡ä»¶ï¼ˆå‰ç«¯èµ„æºç­‰ï¼‰
    
    # --------------------------------------------------------------------
    # ä¼˜åŒ–é…ç½®
    # --------------------------------------------------------------------
    strip=False,     # ä¸å‰¥ç¦»ç¬¦å·
    upx=True,        # ä½¿ç”¨ UPX å‹ç¼©äºŒè¿›åˆ¶æ–‡ä»¶
    upx_exclude=[],  # UPX æ’é™¤åˆ—è¡¨ï¼ˆæŸäº›åº“ä¸å…¼å®¹ UPX å‹ç¼©ï¼‰
    
    # --------------------------------------------------------------------
    # è¾“å‡ºç›®å½•åç§°
    # --------------------------------------------------------------------
    name='wxå…¬ä¼—å·å·¥å…·',  # è¾“å‡ºç›®å½•ï¼šdist/wxå…¬ä¼—å·å·¥å…·/
)

# ============================================================================
# BUNDLE é˜¶æ®µï¼šåˆ›å»º macOS .app åŒ…ï¼ˆä»… macOSï¼‰
# ============================================================================
if is_mac:
    app = BUNDLE(
        coll,  # æ”¶é›†çš„æ–‡ä»¶
        
        # --------------------------------------------------------------------
        # åº”ç”¨åŒ…åç§°
        # --------------------------------------------------------------------
        name='wxå…¬ä¼—å·å·¥å…·.app',  # æœ€ç»ˆè¾“å‡ºï¼šdist/wxå…¬ä¼—å·å·¥å…·.app
        
        # --------------------------------------------------------------------
        # Bundle Identifierï¼ˆmacOS åº”ç”¨å”¯ä¸€æ ‡è¯†ç¬¦ï¼‰
        # æ ¼å¼ï¼šcom.å…¬å¸å.åº”ç”¨å
        # --------------------------------------------------------------------
        bundle_identifier='com.wxcrawler.desktop',
        
        # --------------------------------------------------------------------
        # ğŸ¨ åº”ç”¨å›¾æ ‡ï¼ˆmacOSï¼‰
        # --------------------------------------------------------------------
        icon='resources/icon.icns',  # .app åŒ…çš„å›¾æ ‡
        # ä½¿ç”¨æ–¹æ³•ï¼š
        # 1. å‡†å¤‡ icon.icns æ–‡ä»¶ï¼ˆmacOS å›¾æ ‡æ ¼å¼ï¼‰
        # 2. æ”¾ç½®åœ¨ resources/ ç›®å½•
        # 3. å–æ¶ˆæ­¤è¡Œæ³¨é‡Š
        # 4. å¯ä»¥ä½¿ç”¨åœ¨çº¿å·¥å…·å°† PNG è½¬æ¢ä¸º ICNSï¼š
        #    https://cloudconvert.com/png-to-icns
        
        # --------------------------------------------------------------------
        # Info.plist é…ç½®ï¼ˆmacOS åº”ç”¨ä¿¡æ¯ï¼‰
        # --------------------------------------------------------------------
        info_plist={
            # æ”¯æŒé«˜åˆ†è¾¨ç‡ï¼ˆRetinaï¼‰æ˜¾ç¤º
            'NSHighResolutionCapable': 'True',
            
            # æ˜¯å¦ä¸ºåå°åº”ç”¨ï¼ˆFalse = æ˜¾ç¤ºåœ¨ Dockï¼‰
            'LSUIElement': False,
            
            # ç‰ˆæœ¬å·ï¼ˆçŸ­ç‰ˆæœ¬ï¼Œæ˜¾ç¤ºç»™ç”¨æˆ·ï¼‰
            'CFBundleShortVersionString': '1.0.0',
            
            # ç‰ˆæœ¬å·ï¼ˆå®Œæ•´ç‰ˆæœ¬ï¼Œå†…éƒ¨ä½¿ç”¨ï¼‰
            'CFBundleVersion': '1.0.0',
            
            # ç½‘ç»œå®‰å…¨é…ç½®ï¼ˆå…è®¸ HTTP è¯·æ±‚ï¼‰
            # éœ€è¦è®¿é—®å¾®ä¿¡æœåŠ¡å™¨ï¼ˆHTTPSï¼‰å’Œæœ¬åœ°æœåŠ¡å™¨ï¼ˆHTTPï¼‰
            'NSAppTransportSecurity': {
                'NSAllowsArbitraryLoads': True  # å…è®¸æ‰€æœ‰ç½‘ç»œè¯·æ±‚
            },
            
            # å…¶ä»–å¯é€‰é…ç½®ï¼š
            # 'CFBundleName': 'wxå…¬ä¼—å·å·¥å…·',  # åº”ç”¨åç§°
            # 'CFBundleDisplayName': 'wxå…¬ä¼—å·å·¥å…·',  # æ˜¾ç¤ºåç§°ï¼ˆæ”¯æŒä¸­æ–‡ï¼‰
            # 'NSHumanReadableCopyright': 'Copyright Â© 2025',  # ç‰ˆæƒä¿¡æ¯
        },
    )

# ============================================================================
# æ‰“åŒ…å®Œæˆåçš„è¾“å‡ºç»“æ„
# ============================================================================
# macOS:
#   dist/
#   â”œâ”€â”€ wxå…¬ä¼—å·å·¥å…·.app /          â† åŒå‡»è¿è¡Œ
#   â”‚   â””â”€â”€ Contents/
#   â”‚       â”œâ”€â”€ MacOS/wxå…¬ä¼—å·å·¥å…·
#   â”‚       â”œâ”€â”€ Resources/
#   â”‚       â””â”€â”€ Info.plist
#   â””â”€â”€ wxå…¬ä¼—å·å·¥å…·/              â† ç»ˆç«¯è°ƒè¯•ç”¨
#       â”œâ”€â”€ _internal/
#       â””â”€â”€ wxå…¬ä¼—å·å·¥å…·
#
# Windows:
#   dist/
#   â””â”€â”€ wxå…¬ä¼—å·å·¥å…·/
#       â”œâ”€â”€ _internal/
#       â””â”€â”€ wxå…¬ä¼—å·å·¥å…·.exe       â† åŒå‡»è¿è¡Œ
# ============================================================================