# å·¥å…·ç»“æœæ ¼å¼åŒ–ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

### é”™è¯¯ç°è±¡
```
æ ¼å¼åŒ–å·¥å…·ç»“æœå¤±è´¥: Object of type TextContent is not JSON serializable
```

### åŸå› åˆ†æ

MCPå·¥å…·è°ƒç”¨è¿”å›çš„ç»“æœæ˜¯ `TextContent` å¯¹è±¡åˆ—è¡¨ï¼Œè€Œä¸æ˜¯æ™®é€šçš„å­—ç¬¦ä¸²æˆ–å­—å…¸ï¼š

```python
# å®é™…è¿”å›çš„ç»“æœ
[
    TextContent(
        type='text', 
        text='ç½—å±±å¤©æ°”: å¤šäº‘ï¼Œæ°”æ¸©-20Â°Cï¼Œç©ºæ°”è´¨é‡ä¼˜',
        annotations=None,
        meta=None
    )
]
```

åŸæœ‰çš„ `_format_tool_result` æ–¹æ³•åªå¤„ç†äº†å­—ç¬¦ä¸²ã€å­—å…¸å’Œåˆ—è¡¨ï¼Œä½†æ²¡æœ‰å¤„ç†åŒ…å« `TextContent` å¯¹è±¡çš„åˆ—è¡¨ï¼Œå¯¼è‡´åœ¨å°è¯• JSON åºåˆ—åŒ–æ—¶å¤±è´¥ã€‚

## âœ… ä¿®å¤æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯

å¢å¼º `_format_tool_result` æ–¹æ³•ï¼Œä½¿å…¶èƒ½å¤Ÿè¯†åˆ«å¹¶æ­£ç¡®å¤„ç†å¤šç§æ•°æ®æ ¼å¼ï¼š

1. **å­—ç¬¦ä¸²** â†’ ç›´æ¥è¿”å›
2. **MCPå“åº”å¯¹è±¡** (æœ‰ `content` å±æ€§) â†’ æå– `content` ä¸­çš„ `text`
3. **TextContentå¯¹è±¡åˆ—è¡¨** (åˆ—è¡¨é¡¹æœ‰ `text` å±æ€§) â†’ æå–æ‰€æœ‰ `text` å¹¶åˆå¹¶
4. **æ™®é€šå­—å…¸/åˆ—è¡¨** â†’ è½¬ä¸º JSON
5. **å…¶ä»–ç±»å‹** â†’ è½¬ä¸ºå­—ç¬¦ä¸²

### ä¿®å¤åçš„ä»£ç é€»è¾‘

```python
def _format_tool_result(self, result: Any) -> str:
    """æ ¼å¼åŒ–å·¥å…·æ‰§è¡Œç»“æœä¸ºå­—ç¬¦ä¸²"""
    try:
        # 1. å­—ç¬¦ä¸² - ç›´æ¥è¿”å›
        if isinstance(result, str):
            return result
        
        # 2. MCPå“åº”å¯¹è±¡ - æå–contentä¸­çš„text
        if hasattr(result, 'content'):
            content_texts = []
            for item in result.content:
                if hasattr(item, 'text'):
                    content_texts.append(item.text)
            return '\n'.join(content_texts)
        
        # 3. TextContentå¯¹è±¡åˆ—è¡¨ - æå–æ‰€æœ‰text
        if isinstance(result, list):
            if result and hasattr(result[0], 'text'):
                texts = []
                for item in result:
                    if hasattr(item, 'text'):
                        texts.append(item.text)
                return '\n'.join(texts)
            
            # æ™®é€šåˆ—è¡¨ - è½¬ä¸ºJSON
            try:
                return json.dumps(result, ensure_ascii=False, indent=2)
            except (TypeError, ValueError):
                return str(result)
        
        # 4. å­—å…¸ - è½¬ä¸ºJSON
        if isinstance(result, dict):
            try:
                return json.dumps(result, ensure_ascii=False, indent=2)
            except (TypeError, ValueError):
                return str(result)
        
        # 5. å…¶ä»–ç±»å‹ - è½¬ä¸ºå­—ç¬¦ä¸²
        return str(result)
        
    except Exception as e:
        logger.bind(tag=TAG).error(f"æ ¼å¼åŒ–å¤±è´¥: {e}", exc_info=True)
        return str(result)
```

### å…³é”®æ”¹è¿›ç‚¹

#### 1. æ£€æµ‹ TextContent å¯¹è±¡åˆ—è¡¨

```python
# æ£€æŸ¥æ˜¯å¦æ˜¯åˆ—è¡¨ä¸”ç¬¬ä¸€ä¸ªå…ƒç´ æœ‰textå±æ€§
if isinstance(result, list):
    if result and hasattr(result[0], 'text'):
        # è¿™æ˜¯TextContentå¯¹è±¡åˆ—è¡¨
        texts = [item.text for item in result if hasattr(item, 'text')]
        return '\n'.join(texts)
```

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼š**
- ä¸éœ€è¦å¯¼å…¥ `TextContent` ç±»å‹ï¼ˆé¿å…ä¾èµ–ï¼‰
- ä½¿ç”¨é¸­å­ç±»å‹ï¼ˆduck typingï¼‰ï¼šåªæ£€æŸ¥æ˜¯å¦æœ‰ `text` å±æ€§
- çµæ´»é€‚é…ä¸åŒçš„ MCP å®ç°

#### 2. æ”¯æŒ MCP å“åº”å¯¹è±¡

```python
# æ£€æŸ¥æ˜¯å¦æœ‰contentå±æ€§
if hasattr(result, 'content'):
    content_texts = []
    for item in result.content:
        if hasattr(item, 'text'):
            content_texts.append(item.text)
    return '\n'.join(content_texts)
```

**é€‚ç”¨åœºæ™¯ï¼š**
- MCP ç›´æ¥è¿”å›å“åº”å¯¹è±¡
- å“åº”å¯¹è±¡åŒ…å« `content` åˆ—è¡¨
- æ¯ä¸ª content é¡¹æœ‰ `text` å±æ€§

#### 3. å¢å¼ºçš„æ—¥å¿—è®°å½•

```python
logger.bind(tag=TAG).debug(f"æ ¼å¼åŒ–å·¥å…·ç»“æœç±»å‹: {type(result)}, å€¼: {result}")
logger.bind(tag=TAG).debug(f"âœ… ä»TextContentåˆ—è¡¨æå–æ–‡æœ¬: {formatted}")
logger.bind(tag=TAG).error(f"âŒ æ ¼å¼åŒ–å¤±è´¥: {e}", exc_info=True)
```

**å¥½å¤„ï¼š**
- æ›´å®¹æ˜“è¿½è¸ªé—®é¢˜
- èƒ½çœ‹åˆ°å…·ä½“çš„æ•°æ®ç±»å‹å’Œå€¼
- é”™è¯¯æ—¶æœ‰å®Œæ•´çš„å †æ ˆä¿¡æ¯

## ğŸ“Š å¤„ç†æµç¨‹å›¾

```
å·¥å…·è¿”å›ç»“æœ
    â†“
ç±»å‹æ£€æµ‹
    â”œâ”€ å­—ç¬¦ä¸²? â†’ ç›´æ¥è¿”å› âœ…
    â”œâ”€ æœ‰contentå±æ€§? â†’ æå–contentä¸­çš„text âœ…
    â”œâ”€ åˆ—è¡¨? 
    â”‚   â”œâ”€ ç¬¬ä¸€é¡¹æœ‰textå±æ€§? â†’ æå–æ‰€æœ‰textå¹¶åˆå¹¶ âœ…
    â”‚   â””â”€ æ™®é€šåˆ—è¡¨? â†’ JSONåºåˆ—åŒ–æˆ–str âœ…
    â”œâ”€ å­—å…¸? â†’ JSONåºåˆ—åŒ–æˆ–str âœ…
    â””â”€ å…¶ä»–? â†’ strè½¬æ¢ âœ…
```

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### ç”¨ä¾‹1: TextContentå¯¹è±¡åˆ—è¡¨ï¼ˆåŸé—®é¢˜ï¼‰

**è¾“å…¥ï¼š**
```python
[
    TextContent(type='text', text='ç½—å±±å¤©æ°”: å¤šäº‘ï¼Œæ°”æ¸©-20Â°Cï¼Œç©ºæ°”è´¨é‡ä¼˜')
]
```

**è¾“å‡ºï¼š**
```
ç½—å±±å¤©æ°”: å¤šäº‘ï¼Œæ°”æ¸©-20Â°Cï¼Œç©ºæ°”è´¨é‡ä¼˜
```

### ç”¨ä¾‹2: å¤šä¸ªTextContentå¯¹è±¡

**è¾“å…¥ï¼š**
```python
[
    TextContent(type='text', text='ç¬¬ä¸€è¡Œç»“æœ'),
    TextContent(type='text', text='ç¬¬äºŒè¡Œç»“æœ')
]
```

**è¾“å‡ºï¼š**
```
ç¬¬ä¸€è¡Œç»“æœ
ç¬¬äºŒè¡Œç»“æœ
```

### ç”¨ä¾‹3: MCPå“åº”å¯¹è±¡

**è¾“å…¥ï¼š**
```python
CallToolResult(
    content=[
        TextContent(type='text', text='å·¥å…·æ‰§è¡Œç»“æœ')
    ]
)
```

**è¾“å‡ºï¼š**
```
å·¥å…·æ‰§è¡Œç»“æœ
```

### ç”¨ä¾‹4: æ™®é€šå­—ç¬¦ä¸²

**è¾“å…¥ï¼š**
```python
"ç®€å•çš„å­—ç¬¦ä¸²ç»“æœ"
```

**è¾“å‡ºï¼š**
```
ç®€å•çš„å­—ç¬¦ä¸²ç»“æœ
```

### ç”¨ä¾‹5: å­—å…¸

**è¾“å…¥ï¼š**
```python
{"temperature": 25, "weather": "æ™´å¤©"}
```

**è¾“å‡ºï¼š**
```json
{
  "temperature": 25,
  "weather": "æ™´å¤©"
}
```

## ğŸ” æ—¥å¿—ç¤ºä¾‹

### ä¿®å¤å‰çš„æ—¥å¿—

```
2025-12-30 14:32:08 | WARNING | æ ¼å¼åŒ–å·¥å…·ç»“æœå¤±è´¥: Object of type TextContent is not JSON serializable
```

### ä¿®å¤åçš„æ—¥å¿—

```
2025-12-30 14:32:08 | DEBUG | æ ¼å¼åŒ–å·¥å…·ç»“æœç±»å‹: <class 'list'>, å€¼: [TextContent(...)]
2025-12-30 14:32:08 | DEBUG | æ£€æµ‹åˆ°TextContentå¯¹è±¡åˆ—è¡¨
2025-12-30 14:32:08 | DEBUG | âœ… ä»TextContentåˆ—è¡¨æå–æ–‡æœ¬: ç½—å±±å¤©æ°”: å¤šäº‘ï¼Œæ°”æ¸©-20Â°Cï¼Œç©ºæ°”è´¨é‡ä¼˜
```

## ğŸ’¡ è®¾è®¡è€ƒè™‘

### 1. é¸­å­ç±»å‹ vs æ˜¾å¼ç±»å‹æ£€æŸ¥

**é€‰æ‹©é¸­å­ç±»å‹ï¼š**
```python
# âœ… ä½¿ç”¨é¸­å­ç±»å‹ï¼ˆæ¨èï¼‰
if hasattr(result[0], 'text'):
    ...

# âŒ æ˜¾å¼ç±»å‹æ£€æŸ¥ï¼ˆä¸æ¨èï¼‰
from mcp.types import TextContent
if isinstance(result[0], TextContent):
    ...
```

**åŸå› ï¼š**
- ä¸ä¾èµ–å…·ä½“çš„ MCP å®ç°
- å…¼å®¹æ€§æ›´å¥½
- ä»£ç æ›´ç®€æ´

### 2. å¤šæ¡ç»“æœçš„åˆå¹¶æ–¹å¼

**é€‰æ‹©æ¢è¡Œç¬¦åˆå¹¶ï¼š**
```python
return '\n'.join(texts)
```

**åŸå› ï¼š**
- ä¿æŒå¤šæ¡ç»“æœçš„å¯è¯»æ€§
- AI èƒ½æ›´å¥½åœ°ç†è§£ç»“æ„åŒ–ä¿¡æ¯
- é¿å…ä¿¡æ¯æ··æ·†

### 3. é”™è¯¯å¤„ç†ç­–ç•¥

**é€‰æ‹©ä¼˜é›…é™çº§ï¼š**
```python
try:
    # å°è¯•æ ¼å¼åŒ–
    ...
except Exception as e:
    logger.error(...)
    return str(result)  # å…œåº•å¤„ç†
```

**åŸå› ï¼š**
- ä¸ä¸­æ–­å·¥å…·è°ƒç”¨æµç¨‹
- å§‹ç»ˆè¿”å›å¯ç”¨çš„å­—ç¬¦ä¸²
- è®°å½•é”™è¯¯ä»¥ä¾¿æ’æŸ¥

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### 1. æ”¯æŒæ›´å¤šå†…å®¹ç±»å‹

```python
# é™¤äº†textï¼Œè¿˜å¯èƒ½æœ‰imageã€embedç­‰
if hasattr(item, 'type'):
    if item.type == 'text':
        texts.append(item.text)
    elif item.type == 'image':
        texts.append(f"[å›¾ç‰‡: {item.url}]")
    elif item.type == 'embed':
        texts.append(f"[åµŒå…¥å†…å®¹: {item.data}]")
```

### 2. æ·»åŠ æ ¼å¼åŒ–é…ç½®

```python
def _format_tool_result(
    self, 
    result: Any, 
    format_type: str = 'auto'  # 'auto', 'json', 'text', 'markdown'
) -> str:
    """æ ¹æ®format_typeé€‰æ‹©ä¸åŒçš„æ ¼å¼åŒ–ç­–ç•¥"""
    ...
```

### 3. ç¼“å­˜æ ¼å¼åŒ–ç»“æœ

```python
# é¿å…é‡å¤æ ¼å¼åŒ–ç›¸åŒçš„ç»“æœ
@lru_cache(maxsize=100)
def _format_tool_result_cached(self, result_hash: str) -> str:
    ...
```

## ğŸ“ ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `app/ai/llm/mcp_llm_connect.py` | ä¸»è¦ä¿®æ”¹æ–‡ä»¶ |
| `app/ai/mcp/mcp_client/fastmcp_client.py` | å·¥å…·è°ƒç”¨è¿”å›ç»“æœçš„æ¥æº |
| `app/ai/mcp/mcp_client/client_manager.py` | å·¥å…·æ‰§è¡Œç®¡ç† |

## âœ… éªŒè¯æ–¹æ³•

### é‡å¯åº”ç”¨æµ‹è¯•

```bash
# 1. é‡å¯ä¸»åº”ç”¨
# 2. æµ‹è¯•å·¥å…·è°ƒç”¨
curl -X POST http://localhost:8002/api/v1/ai-assistant/query \
  -H "Content-Type: application/json" \
  -d '{"query": "æŸ¥è¯¢åŒ—äº¬çš„å¤©æ°”"}'

# 3. æŸ¥çœ‹æ—¥å¿—
# åº”è¯¥çœ‹åˆ°ï¼šâœ… ä»TextContentåˆ—è¡¨æå–æ–‡æœ¬: ...
```

### æ£€æŸ¥æ—¥å¿—è¾“å‡º

**æœŸæœ›çœ‹åˆ°ï¼š**
```
âœ… å·¥å…·æ‰§è¡ŒæˆåŠŸ: weather
âœ… ä»TextContentåˆ—è¡¨æå–æ–‡æœ¬: ç½—å±±å¤©æ°”: å¤šäº‘ï¼Œæ°”æ¸©-20Â°Cï¼Œç©ºæ°”è´¨é‡ä¼˜
```

**ä¸åº”è¯¥çœ‹åˆ°ï¼š**
```
âŒ æ ¼å¼åŒ–å·¥å…·ç»“æœå¤±è´¥: Object of type TextContent is not JSON serializable
```

## ğŸ‰ æ€»ç»“

è¿™æ¬¡ä¿®å¤ï¼š
- âœ… è§£å†³äº† TextContent å¯¹è±¡æ— æ³•åºåˆ—åŒ–çš„é—®é¢˜
- âœ… å¢å¼ºäº†ç»“æœæ ¼å¼åŒ–çš„å¥å£®æ€§
- âœ… æ”¯æŒå¤šç§æ•°æ®æ ¼å¼
- âœ… æ”¹è¿›äº†æ—¥å¿—è¾“å‡º
- âœ… ä½¿ç”¨é¸­å­ç±»å‹æé«˜å…¼å®¹æ€§

ç°åœ¨å·¥å…·è°ƒç”¨åº”è¯¥èƒ½å¤Ÿæ­£å¸¸å·¥ä½œäº†ï¼ğŸš€

---

**ä¿®å¤æ—¥æœŸï¼š** 2025-12-30  
**ç›¸å…³é—®é¢˜ï¼š** TextContent åºåˆ—åŒ–é”™è¯¯  
**å½±å“èŒƒå›´ï¼š** æ‰€æœ‰MCPå·¥å…·è°ƒç”¨çš„ç»“æœå¤„ç†

