# MCP Server è‡ªåŠ¨å¯åŠ¨æ–¹æ¡ˆ

## æ¦‚è¿°

æœ¬æ–¹æ¡ˆå®ç°äº†åœ¨æ¡Œé¢åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨å¯åŠ¨æœ¬åœ° MCP Serverï¼Œæ— éœ€æ‰‹åŠ¨ç®¡ç†æœåŠ¡å™¨è¿›ç¨‹ã€‚

## å®ç°åŸç†

### 1. **æœåŠ¡å™¨ç®¡ç†å™¨** (`app/ai/mcp/mcp_server/server_manager.py`)

åˆ›å»ºäº†ä¸€ä¸ª `MCPServerManager` ç±»æ¥ç®¡ç† MCP Server çš„ç”Ÿå‘½å‘¨æœŸï¼š

- **åå°çº¿ç¨‹è¿è¡Œ**: MCP Server åœ¨ç‹¬ç«‹çš„å®ˆæŠ¤çº¿ç¨‹ä¸­è¿è¡Œï¼Œä¸ä¼šé˜»å¡ä¸»åº”ç”¨
- **è‡ªåŠ¨æ¸…ç†**: å½“ä¸»åº”ç”¨é€€å‡ºæ—¶ï¼Œå®ˆæŠ¤çº¿ç¨‹è‡ªåŠ¨ç»“æŸ
- **çŠ¶æ€ç®¡ç†**: æä¾›æœåŠ¡å™¨çŠ¶æ€æŸ¥è¯¢åŠŸèƒ½
- **å•ä¾‹æ¨¡å¼**: ç¡®ä¿åªæœ‰ä¸€ä¸ª MCP Server å®ä¾‹

### 2. **é›†æˆåˆ°åº”ç”¨ç”Ÿå‘½å‘¨æœŸ** (`app/main.py`)

åœ¨ FastAPI çš„ `lifespan` ä¸Šä¸‹æ–‡ç®¡ç†å™¨ä¸­é›†æˆï¼š

```python
@asynccontextmanager
async def lifespan(app: FastAPI):
    # å¯åŠ¨é˜¶æ®µ
    await start_local_mcp_server()  # å¯åŠ¨ MCP Server
    
    yield  # åº”ç”¨è¿è¡Œ
    
    # å…³é—­é˜¶æ®µ
    await stop_local_mcp_server()  # åœæ­¢ MCP Server
```

### 3. **æœåŠ¡å™¨é…ç½®**

é»˜è®¤é…ç½®ï¼š
- **ä¼ è¾“æ–¹å¼**: `streamable-http`
- **ä¸»æœºåœ°å€**: `localhost`
- **ç«¯å£**: `8008`
- **æœåŠ¡åœ°å€**: `http://localhost:8008/mcp`

## åŠŸèƒ½ç‰¹æ€§

### âœ… è‡ªåŠ¨å¯åŠ¨
- æ¡Œé¢åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨å¯åŠ¨ MCP Server
- æ— éœ€æ‰‹åŠ¨è¿è¡Œ `python -m app.ai.mcp.mcp_server.fastmcp_server`

### âœ… è‡ªåŠ¨åœæ­¢
- åº”ç”¨å…³é—­æ—¶è‡ªåŠ¨åœæ­¢ MCP Server
- ä¼˜é›…æ¸…ç†èµ„æº

### âœ… é”™è¯¯å¤„ç†
- å¦‚æœ MCP Server å¯åŠ¨å¤±è´¥ï¼Œåº”ç”¨ä»ä¼šç»§ç»­è¿è¡Œ
- å¤±è´¥ä¿¡æ¯ä¼šè®°å½•åˆ°æ—¥å¿—

### âœ… çº¿ç¨‹å®‰å…¨
- ä½¿ç”¨å®ˆæŠ¤çº¿ç¨‹ï¼Œä¸»ç¨‹åºé€€å‡ºæ—¶è‡ªåŠ¨ç»“æŸ
- ä¸ä¼šé˜»å¡ä¸»åº”ç”¨

## ä½¿ç”¨æ–¹æ³•

### å¼€å‘ç¯å¢ƒæµ‹è¯•

ç›´æ¥è¿è¡Œåº”ç”¨å³å¯ï¼š

```bash
python -m app.main
```

æˆ–ä½¿ç”¨ uvicornï¼š

```bash
uvicorn app.main:app --host localhost --port 8002 --reload
```

### æ¡Œé¢åº”ç”¨æ‰“åŒ…

1. **ç¡®ä¿ spec æ–‡ä»¶å·²é…ç½®**

   åœ¨ `wx_crawler.spec` ä¸­ï¼ŒMCP ç›¸å…³æ–‡ä»¶ä¼šè‡ªåŠ¨æ‰“åŒ…ï¼š
   ```python
   datas=[
       ('app/ai/mcp/mcp_client/mcp_settings.json', 'app/ai/mcp/mcp_client'),
       # MCP Server ä»£ç å·²åŒ…å«åœ¨ Python æ¨¡å—ä¸­
   ]
   ```

2. **æ‰“åŒ…åº”ç”¨**

   ```bash
   pyinstaller wx_crawler.spec
   ```

3. **è¿è¡Œæ‰“åŒ…åçš„åº”ç”¨**

   - **macOS**: åŒå‡» `dist/wxå…¬ä¼—å·å·¥å…·.app`
   - **Windows**: åŒå‡» `dist/wxå…¬ä¼—å·å·¥å…·/wxå…¬ä¼—å·å·¥å…·.exe`

   MCP Server ä¼šè‡ªåŠ¨åœ¨åå°å¯åŠ¨ï¼

## éªŒè¯ MCP Server æ˜¯å¦å¯åŠ¨

### æ–¹æ³• 1: æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—

å¯åŠ¨åº”ç”¨åï¼Œæ§åˆ¶å°ä¼šæ˜¾ç¤ºï¼š

```
================================================================================
ğŸš€ åº”ç”¨å¯åŠ¨ä¸­...
================================================================================
ğŸ“ åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ...
âœ… æ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ
ğŸ—„ï¸  åˆå§‹åŒ–æ•°æ®åº“è¿æ¥...
âœ… æ•°æ®åº“è¿æ¥å®Œæˆ
ğŸ¤– åˆå§‹åŒ–AIåŠ©æ‰‹...
âœ… AIåŠ©æ‰‹åˆå§‹åŒ–å®Œæˆ
ğŸ”Œ å¯åŠ¨æœ¬åœ° MCP Server...
âœ… MCP Server å¯åŠ¨å®Œæˆ - åœ°å€: http://localhost:8008/mcp
================================================================================
âœ… åº”ç”¨å¯åŠ¨å®Œæˆ
================================================================================
```

### æ–¹æ³• 2: è®¿é—®å¥åº·æ£€æŸ¥ç«¯ç‚¹

æµè§ˆå™¨è®¿é—®:
```
http://localhost:8008/mcp
```

æˆ–è€…ä½¿ç”¨ curl:
```bash
curl http://localhost:8008/mcp
```

### æ–¹æ³• 3: æµ‹è¯• MCP å·¥å…·è°ƒç”¨

é€šè¿‡ MCP Client è°ƒç”¨å·¥å…·ï¼š

```python
from app.ai.mcp.mcp_client.client_manager import MCPClientManager

# åˆå§‹åŒ–å®¢æˆ·ç«¯
manager = MCPClientManager()
await manager.init_mcp_clients()

# è°ƒç”¨å¤©æ°”å·¥å…·
response = await manager.call_tool(
    client_name="fastmcp-demo-tools",
    tool_name="weather",
    tool_args={"location": "åŒ—äº¬"}
)

print(response)  # åº”è¯¥è¿”å›åŒ—äº¬çš„å¤©æ°”ä¿¡æ¯
```

## é…ç½®é€‰é¡¹

å¦‚æœéœ€è¦ä¿®æ”¹ MCP Server çš„é…ç½®ï¼Œç¼–è¾‘ `app/ai/mcp/mcp_server/server_manager.py`ï¼š

```python
async def start_local_mcp_server():
    """å¯åŠ¨æœ¬åœ° MCP Server"""
    manager = get_mcp_server_manager()
    
    # ä¿®æ”¹è¿™é‡Œçš„å‚æ•°
    await loop.run_in_executor(
        None,
        manager.start_server,
        "localhost",           # â† ä¸»æœºåœ°å€
        8008,                  # â† ç«¯å£
        "streamable-http"      # â† ä¼ è¾“æ–¹å¼
    )
```

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: ç«¯å£å†²çª

**ç—‡çŠ¶**: å¯åŠ¨æ—¶æç¤ºç«¯å£ 8008 å·²è¢«å ç”¨

**è§£å†³æ–¹æ¡ˆ**:
1. ä¿®æ”¹ `server_manager.py` ä¸­çš„ç«¯å£å·
2. åŒæ—¶æ›´æ–° `mcp_settings.json` ä¸­çš„ URL é…ç½®

### é—®é¢˜ 2: MCP Server æœªå¯åŠ¨

**ç—‡çŠ¶**: æ§åˆ¶å°æ˜¾ç¤º "âš ï¸ MCP Server å¯åŠ¨å¤±è´¥"

**è§£å†³æ–¹æ¡ˆ**:
1. æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—
2. æ£€æŸ¥æ˜¯å¦ç¼ºå°‘ä¾èµ–ï¼š`pip install fastmcp`
3. éªŒè¯ `fastmcp_server.py` æ–‡ä»¶æ˜¯å¦æ­£å¸¸

### é—®é¢˜ 3: æ‰“åŒ…åæ— æ³•è®¿é—®

**ç—‡çŠ¶**: æ‰“åŒ…åçš„åº”ç”¨ä¸­ MCP Server æ— å“åº”

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ `spec` æ–‡ä»¶æ˜¯å¦åŒ…å«å¿…è¦çš„æ¨¡å—
2. æ·»åŠ éšå¼å¯¼å…¥ï¼š
   ```python
   hiddenimports=[
       'app.ai.mcp.mcp_server.fastmcp_server',
       'app.ai.mcp.mcp_server.server_manager',
       'fastmcp',
   ]
   ```

## æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æ¡Œé¢åº”ç”¨å¯åŠ¨                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 FastAPI Lifespan                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  1. åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ                                â”‚   â”‚
â”‚  â”‚  2. è¿æ¥æ•°æ®åº“                                   â”‚   â”‚
â”‚  â”‚  3. åˆå§‹åŒ– AI åŠ©æ‰‹                               â”‚   â”‚
â”‚  â”‚  4. å¯åŠ¨ MCP Server â† æ–°å¢                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              MCPServerManager                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  åˆ›å»ºåå°çº¿ç¨‹                                     â”‚   â”‚
â”‚  â”‚  â”œâ”€ Thread: MCPServerThread                     â”‚   â”‚
â”‚  â”‚  â”‚   â””â”€ FastmcpServer.run()                     â”‚   â”‚
â”‚  â”‚  â”‚       â””â”€ http://localhost:8008/mcp           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               FastAPI ä¸»åº”ç”¨è¿è¡Œ                         â”‚
â”‚         (http://localhost:8002)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ€»ç»“

é€šè¿‡è¿™ä¸ªæ–¹æ¡ˆï¼š

âœ… **ç”¨æˆ·ä½“éªŒ**: å¯åŠ¨æ¡Œé¢åº”ç”¨å³å¯ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½ï¼Œæ— éœ€é¢å¤–æ“ä½œ
âœ… **å¼€å‘ä¾¿åˆ©**: å¼€å‘ç¯å¢ƒä¹Ÿè‡ªåŠ¨å¯åŠ¨ï¼Œç®€åŒ–æµ‹è¯•æµç¨‹
âœ… **èµ„æºç®¡ç†**: è‡ªåŠ¨æ¸…ç†ï¼Œé¿å…èµ„æºæ³„æ¼
âœ… **é”™è¯¯å®¹é”™**: å³ä½¿ MCP Server å¯åŠ¨å¤±è´¥ï¼Œä¸»åº”ç”¨ä»å¯æ­£å¸¸è¿è¡Œ

ç°åœ¨æ‚¨çš„æ¡Œé¢åº”ç”¨ä¼šåœ¨å¯åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œæœ¬åœ° MCP Serverï¼
