# åº”ç”¨åˆå§‹åŒ–é›†æˆæŒ‡å—

## ğŸ¯ ç›®æ ‡

åœ¨åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨åˆå§‹åŒ–AIåŠ©æ‰‹ï¼Œä½¿å…¶åœ¨åº”ç”¨è¿è¡ŒæœŸé—´å¯ç”¨ã€‚

## ğŸ“‹ é›†æˆæ­¥éª¤

### æ–¹æ³•1: åœ¨ `main.py` ä¸­åˆå§‹åŒ–ï¼ˆæ¨èï¼‰

åœ¨ä½ çš„ `app/main.py` æ–‡ä»¶ä¸­æ·»åŠ åˆå§‹åŒ–é€»è¾‘ï¼š

```python
# app/main.py

from fastapi import FastAPI
from contextlib import asynccontextmanager
from loguru import logger

# å¯¼å…¥AIåŠ©æ‰‹åˆå§‹åŒ–å‡½æ•°
from app.api.endpoints.ai_assistant import init_ai_assistant


@asynccontextmanager
async def lifespan(app: FastAPI):
    """åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†"""
    # å¯åŠ¨æ—¶æ‰§è¡Œ
    logger.info("åº”ç”¨å¯åŠ¨ä¸­...")
    
    # åˆå§‹åŒ–AIåŠ©æ‰‹
    try:
        await init_ai_assistant(llm_conn=None)  # å¦‚æœæœ‰llm_connå¯¹è±¡ï¼Œä¼ å…¥
        logger.info("âœ… AIåŠ©æ‰‹å·²åˆå§‹åŒ–")
    except Exception as e:
        logger.warning(f"âš ï¸  AIåŠ©æ‰‹åˆå§‹åŒ–å¤±è´¥: {e}")
        logger.warning("åº”ç”¨å°†ç»§ç»­è¿è¡Œï¼Œä½†AIåŠ©æ‰‹åŠŸèƒ½ä¸å¯ç”¨")
    
    yield
    
    # å…³é—­æ—¶æ‰§è¡Œ
    logger.info("åº”ç”¨å…³é—­ä¸­...")


# åˆ›å»ºFastAPIåº”ç”¨
app = FastAPI(
    title="å¾®ä¿¡å…¬ä¼—å·çˆ¬è™«",
    lifespan=lifespan  # ä½¿ç”¨lifespan
)

# å…¶ä»–ä»£ç ...
```

### æ–¹æ³•2: ä½¿ç”¨å¯åŠ¨äº‹ä»¶ï¼ˆæ—§ç‰ˆæœ¬FastAPIï¼‰

å¦‚æœä½¿ç”¨è¾ƒæ—§çš„FastAPIç‰ˆæœ¬ï¼š

```python
# app/main.py

from fastapi import FastAPI
from loguru import logger
from app.api.endpoints.ai_assistant import init_ai_assistant

app = FastAPI(title="å¾®ä¿¡å…¬ä¼—å·çˆ¬è™«")


@app.on_event("startup")
async def startup_event():
    """åº”ç”¨å¯åŠ¨äº‹ä»¶"""
    logger.info("åº”ç”¨å¯åŠ¨ä¸­...")
    
    # åˆå§‹åŒ–AIåŠ©æ‰‹
    try:
        await init_ai_assistant(llm_conn=None)
        logger.info("âœ… AIåŠ©æ‰‹å·²åˆå§‹åŒ–")
    except Exception as e:
        logger.warning(f"âš ï¸  AIåŠ©æ‰‹åˆå§‹åŒ–å¤±è´¥: {e}")


@app.on_event("shutdown")
async def shutdown_event():
    """åº”ç”¨å…³é—­äº‹ä»¶"""
    logger.info("åº”ç”¨å…³é—­ä¸­...")


# å…¶ä»–ä»£ç ...
```

### æ–¹æ³•3: æ¡Œé¢åº”ç”¨åˆå§‹åŒ– (`run_desktop.py`)

å¦‚æœä½ æœ‰å•ç‹¬çš„æ¡Œé¢åº”ç”¨å¯åŠ¨æ–‡ä»¶ï¼š

```python
# run_desktop.py

import asyncio
import uvicorn
from loguru import logger
from app.main import app
from app.api.endpoints.ai_assistant import init_ai_assistant


async def init_app():
    """åˆå§‹åŒ–åº”ç”¨ç»„ä»¶"""
    logger.info("åˆå§‹åŒ–åº”ç”¨ç»„ä»¶...")
    
    # åˆå§‹åŒ–AIåŠ©æ‰‹
    try:
        await init_ai_assistant(llm_conn=None)
        logger.info("âœ… AIåŠ©æ‰‹å·²åˆå§‹åŒ–")
    except Exception as e:
        logger.warning(f"âš ï¸  AIåŠ©æ‰‹åˆå§‹åŒ–å¤±è´¥: {e}")


def main():
    """å¯åŠ¨æ¡Œé¢åº”ç”¨"""
    # è¿è¡Œåˆå§‹åŒ–
    asyncio.run(init_app())
    
    # å¯åŠ¨æœåŠ¡å™¨
    uvicorn.run(
        app,
        host="127.0.0.1",
        port=8000,
        log_level="info"
    )


if __name__ == "__main__":
    main()
```

## ğŸ”§ å®Œæ•´ç¤ºä¾‹ä»£ç 

### æ¨èçš„ `main.py` å®Œæ•´ç»“æ„

```python
"""
å¾®ä¿¡å…¬ä¼—å·çˆ¬è™«ä¸»åº”ç”¨
"""
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from fastapi.staticfiles import StaticFiles
from contextlib import asynccontextmanager
from pathlib import Path
from loguru import logger

from app.api.api import api_router
from app.core.config import settings
from app.api.endpoints.ai_assistant import init_ai_assistant


@asynccontextmanager
async def lifespan(app: FastAPI):
    """åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†"""
    # ==================== å¯åŠ¨æ—¶æ‰§è¡Œ ====================
    logger.info("="*60)
    logger.info("åº”ç”¨å¯åŠ¨ä¸­...")
    logger.info("="*60)
    
    # 1. åˆå§‹åŒ–AIåŠ©æ‰‹
    try:
        logger.info("æ­£åœ¨åˆå§‹åŒ–AIåŠ©æ‰‹...")
        await init_ai_assistant(llm_conn=None)
        logger.info("âœ… AIåŠ©æ‰‹åˆå§‹åŒ–æˆåŠŸ")
    except Exception as e:
        logger.warning(f"âš ï¸  AIåŠ©æ‰‹åˆå§‹åŒ–å¤±è´¥: {e}")
        logger.warning("åº”ç”¨å°†ç»§ç»­è¿è¡Œï¼Œä½†AIåŠ©æ‰‹åŠŸèƒ½ä¸å¯ç”¨")
    
    # 2. å…¶ä»–åˆå§‹åŒ–ä»»åŠ¡...
    
    logger.info("="*60)
    logger.info("âœ… åº”ç”¨å¯åŠ¨å®Œæˆ")
    logger.info("="*60)
    
    yield
    
    # ==================== å…³é—­æ—¶æ‰§è¡Œ ====================
    logger.info("åº”ç”¨å…³é—­ä¸­...")
    
    # æ¸…ç†èµ„æº...
    
    logger.info("åº”ç”¨å·²å…³é—­")


# åˆ›å»ºFastAPIåº”ç”¨
app = FastAPI(
    title=settings.PROJECT_NAME,
    openapi_url=f"{settings.API_V1_STR}/openapi.json",
    lifespan=lifespan
)

# CORSé…ç½®
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# æ³¨å†Œè·¯ç”±
app.include_router(api_router, prefix=settings.API_V1_STR)

# é™æ€æ–‡ä»¶æœåŠ¡ï¼ˆå‰ç«¯ï¼‰
web_dist = Path(__file__).parent.parent / "web" / "dist"
if web_dist.exists():
    app.mount("/", StaticFiles(directory=str(web_dist), html=True), name="web")

# å¥åº·æ£€æŸ¥
@app.get("/health")
async def health():
    return {"status": "ok"}


if __name__ == "__main__":
    import uvicorn
    uvicorn.run(
        "app.main:app",
        host="0.0.0.0",
        port=8000,
        reload=True  # å¼€å‘æ¨¡å¼
    )
```

## ğŸ“Š éªŒè¯åˆå§‹åŒ–

### 1. æŸ¥çœ‹åº”ç”¨å¯åŠ¨æ—¥å¿—

å¯åŠ¨åº”ç”¨åï¼Œåº”è¯¥çœ‹åˆ°ç±»ä¼¼çš„æ—¥å¿—ï¼š

```
============================================================
åº”ç”¨å¯åŠ¨ä¸­...
============================================================
æ­£åœ¨åˆå§‹åŒ–AIåŠ©æ‰‹...
[MCP_MANAGER] å¼€å§‹åˆå§‹åŒ–MCPå®¢æˆ·ç«¯...
[MCP_MANAGER] é…ç½®æ–‡ä»¶è·¯å¾„: .../mcp_settings.json
[MCP_MANAGER] æ­£åœ¨åˆå§‹åŒ–å®¢æˆ·ç«¯ [fastmcp-demo-tools]...
[FASTMCP_CLIENT] [fastmcp-demo-tools] âœ… å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ
[MCP_MANAGER] âœ… MCPå®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ
[MCP_LLM_CONNECT] âœ… MCP-LLMè¿æ¥å™¨å·²åˆå§‹åŒ–
   AIæ¨¡å‹: gpt-3.5-turbo
   æœ€å¤§å·¥å…·è°ƒç”¨: 10
   è‡ªåŠ¨æ‰§è¡Œå·¥å…·: True
âœ… AIåŠ©æ‰‹åˆå§‹åŒ–æˆåŠŸ
============================================================
âœ… åº”ç”¨å¯åŠ¨å®Œæˆ
============================================================
```

### 2. æµ‹è¯•å¥åº·æ£€æŸ¥

```bash
# æ£€æŸ¥åº”ç”¨æ˜¯å¦è¿è¡Œ
curl http://localhost:8000/health

# æ£€æŸ¥AIåŠ©æ‰‹çŠ¶æ€
curl http://localhost:8000/api/v1/ai/health
```

**æœŸæœ›è¿”å›ï¼š**
```json
{
  "status": "ok",
  "ai_available": true
}
```

### 3. æµ‹è¯•AIæŸ¥è¯¢

```bash
curl -X POST http://localhost:8000/api/v1/ai/query \
  -H "Content-Type: application/json" \
  -d '{"query": "ä½ å¥½"}'
```

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜1: AIåŠ©æ‰‹åˆå§‹åŒ–å¤±è´¥

**æ—¥å¿—æ˜¾ç¤º**: `âš ï¸  AIåŠ©æ‰‹åˆå§‹åŒ–å¤±è´¥: ...`

**åŸå› **: MCPæœåŠ¡å™¨æœªè¿è¡Œ

**è§£å†³**:
```bash
# åœ¨å¦ä¸€ä¸ªç»ˆç«¯å¯åŠ¨MCPæœåŠ¡
python app/ai/mcp/mcp_server/run_server.py
```

### é—®é¢˜2: è¿æ¥è¶…æ—¶

**æ—¥å¿—æ˜¾ç¤º**: `Connection timeout`

**æ£€æŸ¥æ¸…å•**:
1. âœ… MCPæœåŠ¡æ˜¯å¦åœ¨ `localhost:8008` è¿è¡Œï¼Ÿ
2. âœ… é…ç½®æ–‡ä»¶URLæ˜¯å¦æ­£ç¡®ï¼Ÿ
3. âœ… é˜²ç«å¢™æ˜¯å¦é˜»æ­¢è¿æ¥ï¼Ÿ

**è§£å†³**:
```bash
# æ£€æŸ¥MCPæœåŠ¡
curl http://localhost:8008/mcp

# æŸ¥çœ‹MCPæœåŠ¡è¿›ç¨‹
ps aux | grep fastmcp_server
```

### é—®é¢˜3: å·¥å…·åˆ—è¡¨ä¸ºç©º

**æ—¥å¿—æ˜¾ç¤º**: `å¯ç”¨å·¥å…·æ•°é‡: 0`

**åŸå› **: MCPå®¢æˆ·ç«¯æœªæ­£ç¡®åŠ è½½å·¥å…·

**è§£å†³**:
1. é‡å¯MCPæœåŠ¡å™¨
2. æ£€æŸ¥ `mcp_settings.json` é…ç½®
3. æŸ¥çœ‹MCPæœåŠ¡å™¨æ—¥å¿—

## ğŸ“ æ³¨æ„äº‹é¡¹

### 1. å¼‚æ­¥åˆå§‹åŒ–

AIåŠ©æ‰‹åˆå§‹åŒ–æ˜¯å¼‚æ­¥çš„ï¼Œå¿…é¡»ä½¿ç”¨ `await`ï¼š

```python
# âœ… æ­£ç¡®
await init_ai_assistant()

# âŒ é”™è¯¯
init_ai_assistant()  # ä¸ä¼šçœŸæ­£åˆå§‹åŒ–
```

### 2. é”™è¯¯å¤„ç†

åˆå§‹åŒ–å¤±è´¥ä¸åº”è¯¥é˜»æ­¢åº”ç”¨å¯åŠ¨ï¼š

```python
try:
    await init_ai_assistant()
except Exception as e:
    logger.warning(f"AIåŠ©æ‰‹åˆå§‹åŒ–å¤±è´¥: {e}")
    # åº”ç”¨ç»§ç»­è¿è¡Œ
```

### 3. llm_connå‚æ•°

å¦‚æœä½ çš„é¡¹ç›®æœ‰è‡ªå®šä¹‰çš„LLMè¿æ¥å¯¹è±¡ï¼Œä¼ å…¥ï¼š

```python
# å‡è®¾ä½ æœ‰ä¸€ä¸ªå…¨å±€çš„llmè¿æ¥
from app.some_module import get_llm_connection

llm_conn = get_llm_connection()
await init_ai_assistant(llm_conn=llm_conn)
```

## ğŸ”„ å¼€å‘æµç¨‹

### å®Œæ•´å¯åŠ¨æµç¨‹

```bash
# ç»ˆç«¯1: å¯åŠ¨MCPæœåŠ¡
cd /Users/yuye/YeahWork/Pythoné¡¹ç›®/wxPublicCrawl
source venv/bin/activate
python app/ai/mcp/mcp_server/run_server.py

# ç»ˆç«¯2: å¯åŠ¨ä¸»åº”ç”¨
cd /Users/yuye/YeahWork/Pythoné¡¹ç›®/wxPublicCrawl
source venv/bin/activate
python app/main.py
# æˆ–
python run_desktop.py
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# å®æ—¶æŸ¥çœ‹åº”ç”¨æ—¥å¿—
tail -f logs/app_run/app_run_*.log

# æŸ¥çœ‹AIç›¸å…³æ—¥å¿—
grep "MCP\|AI_ASSISTANT" logs/app_run/app_run_*.log
```

## âœ… é›†æˆæ£€æŸ¥æ¸…å•

- [ ] åœ¨ `main.py` ä¸­æ·»åŠ äº† `lifespan` æˆ– `startup` äº‹ä»¶
- [ ] å¯¼å…¥äº† `init_ai_assistant` å‡½æ•°
- [ ] æ·»åŠ äº†å¼‚å¸¸å¤„ç†
- [ ] æµ‹è¯•äº†å¯åŠ¨æµç¨‹
- [ ] æŸ¥çœ‹äº†åˆå§‹åŒ–æ—¥å¿—
- [ ] éªŒè¯äº† `/api/v1/ai/health` ç«¯ç‚¹
- [ ] æµ‹è¯•äº†AIæŸ¥è¯¢åŠŸèƒ½

---

**æ–‡æ¡£æ›´æ–°æ—¶é—´**: 2025-12-29  
**çŠ¶æ€**: âœ… å®Œæ•´

