# ç«¯å£å ç”¨é—®é¢˜è§£å†³æ–¹æ¡ˆ

## ğŸ› é—®é¢˜æè¿°

### é”™è¯¯æ—¥å¿—
```
ERROR: [Errno 48] error while attempting to bind on address ('127.0.0.1', 8008): [errno 48] address already in use
```

### åŸå› 
- MCP Server å¯åŠ¨æ—¶ï¼Œç«¯å£ 8008 å·²è¢«å ç”¨
- å¯èƒ½æ˜¯ä¹‹å‰çš„ MCP Server è¿›ç¨‹æœªæ­£å¸¸å…³é—­
- æˆ–è€…æœ‰å…¶ä»–ç¨‹åºå ç”¨äº†è¯¥ç«¯å£

## âœ… è§£å†³æ–¹æ¡ˆ

### è‡ªåŠ¨ç«¯å£æ¸…ç†æœºåˆ¶

åœ¨ `server_manager.py` ä¸­æ·»åŠ äº†è‡ªåŠ¨æ£€æŸ¥å’Œæ¸…ç†åŠŸèƒ½ï¼š

#### 1. ç«¯å£æ£€æŸ¥æ–¹æ³•

```python
@staticmethod
def is_port_in_use(host: str, port: int) -> bool:
    """æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨"""
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
        try:
            s.bind((host, port))
            return False  # å¯ä»¥ç»‘å®šï¼Œç«¯å£ç©ºé—²
        except OSError:
            return True   # æ— æ³•ç»‘å®šï¼Œç«¯å£è¢«å ç”¨
```

#### 2. è¿›ç¨‹æ¸…ç†æ–¹æ³•

```python
@staticmethod
def kill_process_on_port(port: int):
    """æ€æ­»å ç”¨æŒ‡å®šç«¯å£çš„è¿›ç¨‹"""
    result = subprocess.run(
        ['lsof', '-ti', f':{port}'],
        capture_output=True,
        text=True
    )
    
    if result.returncode == 0 and result.stdout.strip():
        pids = result.stdout.strip().split('\n')
        for pid in pids:
            os.kill(int(pid), signal.SIGTERM)
```

#### 3. å¯åŠ¨å‰è‡ªåŠ¨æ¸…ç†

```python
def start_server(self, host="127.0.0.1", port=8008, ...):
    # æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
    if self.is_port_in_use(host, port):
        logger.warning(f"âš ï¸  ç«¯å£ {port} å·²è¢«å ç”¨ï¼Œå°è¯•æ¸…ç†...")
        self.kill_process_on_port(port)
        
        # å†æ¬¡æ£€æŸ¥
        time.sleep(1)
        if self.is_port_in_use(host, port):
            logger.error(f"âŒ ç«¯å£ {port} ä»è¢«å ç”¨ï¼Œæ— æ³•å¯åŠ¨")
            return
    
    # å¯åŠ¨æœåŠ¡å™¨
    ...
```

## ğŸ“Š å·¥ä½œæµç¨‹

```
å¯åŠ¨ MCP Server
    â†“
æ£€æŸ¥ç«¯å£ 8008 æ˜¯å¦è¢«å ç”¨ï¼Ÿ
    â†“
YES â†’ æŸ¥æ‰¾å ç”¨è¿›ç¨‹ (lsof)
    â†“
    ç»ˆæ­¢è¿›ç¨‹ (SIGTERM)
    â†“
    ç­‰å¾… 1 ç§’
    â†“
    å†æ¬¡æ£€æŸ¥ç«¯å£
    â†“
    ä»è¢«å ç”¨ï¼Ÿ â†’ å¯åŠ¨å¤±è´¥ âŒ
    â†“
NO â†’ å¯åŠ¨ MCP Server âœ…
```

## ğŸ”§ æ‰‹åŠ¨æ¸…ç†å‘½ä»¤

å¦‚æœè‡ªåŠ¨æ¸…ç†å¤±è´¥ï¼Œå¯ä»¥æ‰‹åŠ¨æ‰§è¡Œï¼š

### macOS/Linux

```bash
# æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹
lsof -i :8008

# æˆ–è€…
netstat -an | grep 8008

# æ€æ­»è¿›ç¨‹
kill -9 <PID>

# æ‰¹é‡æ€æ­»æ‰€æœ‰å ç”¨ 8008 çš„è¿›ç¨‹
lsof -ti:8008 | xargs kill -9
```

### Windows

```cmd
# æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹
netstat -ano | findstr :8008

# æ€æ­»è¿›ç¨‹
taskkill /PID <PID> /F
```

## ğŸ¯ å®Œæ•´ä¿®æ”¹

### ä¿®æ”¹çš„æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|---------|
| `server_manager.py` | âœ… æ·»åŠ ç«¯å£æ£€æŸ¥å’Œæ¸…ç†æ–¹æ³• |
| `server_manager.py` | âœ… å¯åŠ¨å‰è‡ªåŠ¨æ£€æŸ¥å’Œæ¸…ç† |
| `run_server.py` | âœ… è·¯å¾„ä¿®å¤ï¼ˆ5ä¸ªparentï¼‰ |
| `run_server.py` | âœ… ä½¿ç”¨ 127.0.0.1 è€Œé localhost |

### æ–°å¢ä¾èµ–

```python
import socket     # ç«¯å£æ£€æŸ¥
import signal     # è¿›ç¨‹ä¿¡å·
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤

1. **æ­£å¸¸å¯åŠ¨**
   ```bash
   python run_app.py
   ```
   
   **æœŸæœ›æ—¥å¿—ï¼š**
   ```
   ğŸš€ å¯åŠ¨ MCP Server - streamable-http://127.0.0.1:8008/mcp
   âœ… MCP Server å¯åŠ¨æˆåŠŸ - åœ°å€: http://127.0.0.1:8008/mcp
      è¿›ç¨‹ PID: xxxxx
   ```

2. **ç«¯å£è¢«å ç”¨æ—¶**
   ```bash
   # å…ˆæ‰‹åŠ¨å¯åŠ¨ä¸€ä¸ªå ç”¨ 8008 çš„è¿›ç¨‹
   python app/ai/mcp/mcp_server/run_server.py &
   
   # å†å¯åŠ¨ä¸»åº”ç”¨
   python run_app.py
   ```
   
   **æœŸæœ›æ—¥å¿—ï¼š**
   ```
   âš ï¸  ç«¯å£ 8008 å·²è¢«å ç”¨ï¼Œå°è¯•æ¸…ç†...
   æ­£åœ¨ç»ˆæ­¢å ç”¨ç«¯å£ 8008 çš„è¿›ç¨‹ (PID: xxxxx)
   âœ… å·²æ¸…ç†ç«¯å£ 8008
   ğŸš€ å¯åŠ¨ MCP Server - streamable-http://127.0.0.1:8008/mcp
   âœ… MCP Server å¯åŠ¨æˆåŠŸ
   ```

3. **æ‰“åŒ…ç¯å¢ƒæµ‹è¯•**
   ```bash
   python build_desktop.py
   open dist/wxå…¬ä¼—å·å·¥å…·.app
   ```

## ğŸ” æ—¥å¿—è¯´æ˜

### æ­£å¸¸å¯åŠ¨æ—¥å¿—

```
[INFO] ğŸš€ å¯åŠ¨ MCP Server - streamable-http://127.0.0.1:8008/mcp
[DEBUG] å¼€å‘ç¯å¢ƒ - Python: .../venv/bin/python
[DEBUG] å¼€å‘ç¯å¢ƒ - Script: .../run_server.py
[DEBUG] å¼€å‘ç¯å¢ƒ - Script exists: True
[INFO] âœ… MCP Server å¯åŠ¨æˆåŠŸ - åœ°å€: http://127.0.0.1:8008/mcp
[INFO]    è¿›ç¨‹ PID: 12345
```

### ç«¯å£è¢«å ç”¨æ—¥å¿—

```
[WARNING] âš ï¸  ç«¯å£ 8008 å·²è¢«å ç”¨ï¼Œå°è¯•æ¸…ç†...
[INFO] æ­£åœ¨ç»ˆæ­¢å ç”¨ç«¯å£ 8008 çš„è¿›ç¨‹ (PID: 12345)
[INFO] âœ… å·²æ¸…ç†ç«¯å£ 8008
[INFO] ğŸš€ å¯åŠ¨ MCP Server - streamable-http://127.0.0.1:8008/mcp
```

### æ¸…ç†å¤±è´¥æ—¥å¿—

```
[WARNING] âš ï¸  ç«¯å£ 8008 å·²è¢«å ç”¨ï¼Œå°è¯•æ¸…ç†...
[INFO] æ­£åœ¨ç»ˆæ­¢å ç”¨ç«¯å£ 8008 çš„è¿›ç¨‹ (PID: 12345)
[ERROR] âŒ ç«¯å£ 8008 ä»è¢«å ç”¨ï¼Œæ— æ³•å¯åŠ¨ MCP Server
```

## ğŸš¨ å¸¸è§é—®é¢˜

### Q1: ç«¯å£æ¸…ç†å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

**A:** æ‰‹åŠ¨æ¸…ç†ï¼š
```bash
lsof -ti:8008 | xargs kill -9
```

### Q2: è¿›ç¨‹æ— æ³•ç»ˆæ­¢ï¼Ÿ

**A:** ä½¿ç”¨ SIGKILLï¼ˆå¼ºåˆ¶ï¼‰ï¼š
```bash
kill -9 <PID>
```

### Q3: ä¸æƒ³æ€æ­»ç°æœ‰è¿›ç¨‹ï¼Ÿ

**A:** ä¿®æ”¹ç«¯å£å·ï¼š

```python
# server_manager.py
manager.start_server(host="127.0.0.1", port=8009)  # æ”¹ä¸º 8009

# mcp_settings.json
{
    "mcp_server_url": "http://127.0.0.1:8009/mcp"
}
```

### Q4: macOS è¯´æƒé™ä¸è¶³ï¼Ÿ

**A:** å¯èƒ½éœ€è¦ç®¡ç†å‘˜æƒé™ï¼š
```bash
sudo lsof -ti:8008 | xargs sudo kill -9
```

ä½†é€šå¸¸ä¸éœ€è¦ sudoï¼Œå› ä¸ºæ˜¯è‡ªå·±å¯åŠ¨çš„è¿›ç¨‹ã€‚

## ğŸ“ å¼€å‘å»ºè®®

### 1. å¼€å‘æ—¶ä½¿ç”¨ä¸åŒç«¯å£

ä¸ºäº†é¿å…å†²çªï¼Œå¯ä»¥ï¼š
- ä¸»åº”ç”¨ MCP Server: 8008
- æ‰‹åŠ¨æµ‹è¯• MCP Server: 8009

### 2. ä½¿ç”¨è¿›ç¨‹ç®¡ç†å·¥å…·

```bash
# ä½¿ç”¨ pm2 ç®¡ç†è¿›ç¨‹ï¼ˆå¦‚æœå®‰è£…äº†ï¼‰
pm2 start app/ai/mcp/mcp_server/run_server.py --name mcp-server
pm2 stop mcp-server
pm2 restart mcp-server
```

### 3. æ·»åŠ å¥åº·æ£€æŸ¥

```python
def check_server_health(host="127.0.0.1", port=8008):
    """æ£€æŸ¥ MCP Server æ˜¯å¦å¥åº·"""
    try:
        import requests
        response = requests.get(f"http://{host}:{port}/health", timeout=2)
        return response.status_code == 200
    except:
        return False
```

## âœ¨ æ€»ç»“

### é—®é¢˜
- ç«¯å£ 8008 è¢«å ç”¨ï¼Œå¯¼è‡´ MCP Server æ— æ³•å¯åŠ¨

### è§£å†³
- âœ… è‡ªåŠ¨æ£€æµ‹ç«¯å£å ç”¨
- âœ… è‡ªåŠ¨æ¸…ç†å ç”¨è¿›ç¨‹
- âœ… å¯åŠ¨å‰éªŒè¯ç«¯å£å¯ç”¨æ€§
- âœ… è¯¦ç»†çš„æ—¥å¿—è¾“å‡º

### æ•ˆæœ
- å¼€å‘ç¯å¢ƒï¼šè‡ªåŠ¨æ¸…ç†ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„
- æ‰“åŒ…ç¯å¢ƒï¼šé¿å…ç«¯å£å†²çª
- ç”¨æˆ·ä½“éªŒï¼šé€æ˜å¤„ç†ï¼Œæ— æ„ŸçŸ¥

---

**ä¿®å¤æ—¥æœŸï¼š** 2025-12-31  
**é—®é¢˜ç±»å‹ï¼š** ç«¯å£å ç”¨  
**å½±å“èŒƒå›´ï¼š** MCP Server å¯åŠ¨æµç¨‹

