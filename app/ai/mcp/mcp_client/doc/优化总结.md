# MCPå®¢æˆ·ç«¯ä»£ç ä¼˜åŒ–æ€»ç»“

## ğŸ“‹ ä¼˜åŒ–æ¦‚è¿°

å¯¹MCPå®¢æˆ·ç«¯æ¨¡å—è¿›è¡Œäº†å…¨é¢ä¼˜åŒ–ï¼Œæå‡ä»£ç è´¨é‡ã€å¯ç»´æŠ¤æ€§å’Œè°ƒè¯•ä½“éªŒã€‚

## âœ… ä¸»è¦ä¼˜åŒ–å†…å®¹

### 1. æ—¥å¿—ç³»ç»Ÿä¼˜åŒ–

**ä¼˜åŒ–å‰:**
- `print` å’Œ `logger` æ··ç”¨
- æ—¥å¿—ä¿¡æ¯ä¸è§„èŒƒ
- ç¼ºå°‘æ—¥å¿—çº§åˆ«åŒºåˆ†
- è°ƒè¯•ä¿¡æ¯å†—ä½™

**ä¼˜åŒ–å:**
- âœ… ç»Ÿä¸€ä½¿ç”¨ `logger` è®°å½•æ—¥å¿—
- âœ… è§„èŒƒçš„æ—¥å¿—æ ¼å¼å’Œæ ‡ç­¾ï¼ˆTAGï¼‰
- âœ… æ˜ç¡®çš„æ—¥å¿—çº§åˆ«ï¼ˆDEBUG/INFO/WARNING/ERRORï¼‰
- âœ… ç»“æ„åŒ–çš„æ—¥å¿—è¾“å‡º

**ç¤ºä¾‹:**
```python
# ä¼˜åŒ–å‰
print('load_config-----', self.config)
print('mcp_server_url-----', self.mcp_server_url)

# ä¼˜åŒ–å
logger.bind(tag=TAG).info(
    f"âœ… é…ç½®åŠ è½½æˆåŠŸ - æœåŠ¡åœ°å€: {self.mcp_server_url}, "
    f"æœåŠ¡æ•°é‡: {len(self.mcp_servers)}"
)
```

### 2. ç±»å‹æç¤ºå®Œå–„

**ä¼˜åŒ–å‰:**
- ç¼ºå°‘ç±»å‹æç¤º
- å‚æ•°ç±»å‹ä¸æ˜ç¡®
- è¿”å›å€¼ç±»å‹æœªæ ‡æ³¨

**ä¼˜åŒ–å:**
- âœ… å®Œæ•´çš„ç±»å‹æç¤ºï¼ˆtypingæ¨¡å—ï¼‰
- âœ… å‚æ•°å’Œè¿”å›å€¼ç±»å‹æ˜ç¡®
- âœ… æå‡IDEæ™ºèƒ½æç¤º

**ç¤ºä¾‹:**
```python
# ä¼˜åŒ–å‰
async def execute_tool(self, tool_name, tool_args):

# ä¼˜åŒ–å
async def execute_tool(
    self, 
    tool_name: str, 
    tool_args: Dict[str, Any]
) -> Any:
```

### 3. é”™è¯¯å¤„ç†æ”¹è¿›

**ä¼˜åŒ–å‰:**
- ç®€å•çš„try-except
- é”™è¯¯ä¿¡æ¯ä¸è¯¦ç»†
- ç¼ºå°‘å¼‚å¸¸é“¾è¿½è¸ª

**ä¼˜åŒ–å:**
- âœ… è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
- âœ… å¼‚å¸¸é“¾è¿½è¸ªï¼ˆexc_info=Trueï¼‰
- âœ… å‹å¥½çš„é”™è¯¯æç¤º
- âœ… å¤±è´¥ç»Ÿè®¡å’Œæ€»ç»“

**ç¤ºä¾‹:**
```python
# ä¼˜åŒ–å‰
except Exception as e:
    self.logger.bind(tag=name).error(
        f"Failed to initialize client {name}: {str(e)}"
    )

# ä¼˜åŒ–å
except Exception as e:
    fail_count += 1
    logger.bind(tag=TAG).error(
        f"âŒ æœåŠ¡ {server_name} åˆå§‹åŒ–å¤±è´¥: {e}",
        exc_info=True  # åŒ…å«å®Œæ•´å †æ ˆä¿¡æ¯
    )
```

### 4. ä»£ç ç»“æ„ä¼˜åŒ–

**ä¼˜åŒ–å‰:**
- å•ä¸ªå¤§å‡½æ•°å¤„ç†æ‰€æœ‰é€»è¾‘
- ä»£ç è€¦åˆåº¦é«˜
- éš¾ä»¥æµ‹è¯•å’Œç»´æŠ¤

**ä¼˜åŒ–å:**
- âœ… æ‹†åˆ†ä¸ºå¤šä¸ªå°å‡½æ•°
- âœ… å•ä¸€èŒè´£åŸåˆ™
- âœ… æ˜“äºæµ‹è¯•å’Œç»´æŠ¤
- âœ… æ›´å¥½çš„ä»£ç å¤ç”¨

**ç¤ºä¾‹:**
```python
# ä¼˜åŒ–å‰
async def init_client(self):
    # 200è¡Œä»£ç å¤„ç†æ‰€æœ‰é€»è¾‘

# ä¼˜åŒ–å
async def init_client(self):
    if transport_type == "streamable-http":
        await self._init_http_client()
    else:
        await self._init_stdio_client()

async def _init_http_client(self):
    # ä¸“é—¨å¤„ç†HTTPè¿æ¥

async def _init_stdio_client(self):
    # ä¸“é—¨å¤„ç†stdioè¿æ¥
```

### 5. æ–‡æ¡£å­—ç¬¦ä¸²å®Œå–„

**ä¼˜åŒ–å‰:**
- ç®€å•çš„å•è¡Œæ³¨é‡Š
- ç¼ºå°‘å‚æ•°è¯´æ˜
- æ²¡æœ‰è¿”å›å€¼è¯´æ˜

**ä¼˜åŒ–å:**
- âœ… è¯¦ç»†çš„docstring
- âœ… å‚æ•°è¯´æ˜ï¼ˆArgsï¼‰
- âœ… è¿”å›å€¼è¯´æ˜ï¼ˆReturnsï¼‰
- âœ… å¼‚å¸¸è¯´æ˜ï¼ˆRaisesï¼‰
- âœ… åŠŸèƒ½æè¿°

**ç¤ºä¾‹:**
```python
async def execute_tool(self, tool_name: str, tool_args: Dict[str, Any]) -> Any:
    """
    æ‰§è¡ŒMCPå·¥å…·è°ƒç”¨
    
    å·¥ä½œæµç¨‹ï¼š
    1. ç§»é™¤ 'mcp_' å‰ç¼€ï¼ˆå¦‚æœæœ‰ï¼‰
    2. éå†æ‰€æœ‰å®¢æˆ·ç«¯æŸ¥æ‰¾åŒ…å«è¯¥å·¥å…·çš„å®¢æˆ·ç«¯
    3. è°ƒç”¨å¯¹åº”å®¢æˆ·ç«¯çš„å·¥å…·
    4. è¿”å›ç»“æœ
    
    Args:
        tool_name: å·¥å…·åç§°ï¼ˆå¯èƒ½å¸¦æœ‰ 'mcp_' å‰ç¼€ï¼‰
        tool_args: å·¥å…·å‚æ•°å­—å…¸
        
    Returns:
        Any: å·¥å…·æ‰§è¡Œç»“æœ
        
    Raises:
        ValueError: å·¥å…·æœªæ‰¾åˆ°æˆ–æ‰§è¡Œå¤±è´¥æ—¶æŠ›å‡º
    """
```

### 6. é…ç½®è·¯å¾„å¤„ç†

**ä¼˜åŒ–å‰:**
- ç¡¬ç¼–ç ç›¸å¯¹è·¯å¾„
- æ‰“åŒ…åæ‰¾ä¸åˆ°é…ç½®æ–‡ä»¶

**ä¼˜åŒ–å:**
- âœ… ä½¿ç”¨ `get_resource_path()` å¤„ç†è·¯å¾„
- âœ… æ”¯æŒå¼€å‘å’Œæ‰“åŒ…ç¯å¢ƒ
- âœ… è‡ªåŠ¨é€‚é…ä¸åŒå¹³å°

**ç¤ºä¾‹:**
```python
# ä¼˜åŒ–å‰
self.config_path = os.path.join(os.path.dirname(__file__), "mcp_settings.json")

# ä¼˜åŒ–å
config_relative_path = "app/ai/mcp/mcp_client/mcp_settings.json"
self.config_path = get_resource_path(config_relative_path)
```

### 7. æ–°å¢åŠŸèƒ½

#### 7.1 å®¢æˆ·ç«¯çŠ¶æ€æŸ¥è¯¢

```python
# è·å–æ‰€æœ‰å®¢æˆ·ç«¯çŠ¶æ€
status = manager.get_client_status()
print(json.dumps(status, indent=2, ensure_ascii=False))
```

è¾“å‡º:
```json
{
  "total_clients": 2,
  "total_tools": 8,
  "clients": {
    "weather-service": {
      "connected": true,
      "tool_count": 3,
      "tools": ["search_weather", "get_forecast", "get_alerts"]
    }
  }
}
```

#### 7.2 åˆå§‹åŒ–ç»“æœç»Ÿè®¡

```
[MCP_MANAGER] 
============================================================
MCPå®¢æˆ·ç«¯åˆå§‹åŒ–å®Œæˆ
  æˆåŠŸ: 2/3
  å¤±è´¥: 1/3
  å·¥å…·æ€»æ•°: 10
============================================================
```

#### 7.3 è¯¦ç»†çš„å·¥å…·è°ƒç”¨æ—¥å¿—

```
[MCP_MANAGER] ğŸ”§ æ‰§è¡ŒMCPå·¥å…·: search_weather
   å‚æ•°: {'city': 'åŒ—äº¬'}
[MCP_MANAGER]   âœ“ åœ¨å®¢æˆ·ç«¯ [weather-service] ä¸­æ‰¾åˆ°å·¥å…·
[FASTMCP_CLIENT] [weather-service] ğŸ”§ è°ƒç”¨å·¥å…·: search_weather
   å‚æ•°: {'city': 'åŒ—äº¬'}
[FASTMCP_CLIENT] [weather-service] âœ… å·¥å…·è°ƒç”¨æˆåŠŸ: search_weather
[MCP_MANAGER]   âœ… å·¥å…·æ‰§è¡ŒæˆåŠŸ: search_weather
```

## ğŸ“Š ä¼˜åŒ–æ•ˆæœå¯¹æ¯”

### ä»£ç è´¨é‡

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| ç±»å‹æç¤ºè¦†ç›–ç‡ | 0% | 100% | âœ… |
| æ–‡æ¡£å­—ç¬¦ä¸²å®Œæ•´æ€§ | 30% | 100% | âœ… |
| æ—¥å¿—è§„èŒƒæ€§ | 40% | 100% | âœ… |
| é”™è¯¯å¤„ç†å®Œå–„åº¦ | 50% | 100% | âœ… |
| ä»£ç å¯ç»´æŠ¤æ€§ | â­â­ | â­â­â­â­â­ | âœ… |

### è°ƒè¯•ä½“éªŒ

| åŠŸèƒ½ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|------|--------|--------|
| æ—¥å¿—æ¸…æ™°åº¦ | âŒ printæ··ä¹± | âœ… ç»“æ„åŒ–æ—¥å¿— |
| é”™è¯¯å®šä½ | âŒ éš¾ä»¥å®šä½ | âœ… è¯¦ç»†å †æ ˆ |
| çŠ¶æ€æŸ¥è¯¢ | âŒ ä¸æ”¯æŒ | âœ… å®Œæ•´æ”¯æŒ |
| æ‰§è¡Œè¿½è¸ª | âŒ ä¿¡æ¯ä¸è¶³ | âœ… å®Œæ•´è¿½è¸ª |

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### 1. client_manager.py

**ä¸»è¦ä¿®æ”¹:**
- âœ… ç±»åæ”¹ä¸º `MCPClientManager`ï¼ˆæ›´è§„èŒƒï¼‰
- âœ… å®Œæ•´çš„ç±»å‹æç¤º
- âœ… è¯¦ç»†çš„æ–‡æ¡£å­—ç¬¦ä¸²
- âœ… ä¼˜åŒ–çš„æ—¥å¿—è¾“å‡º
- âœ… æ”¹è¿›çš„é”™è¯¯å¤„ç†
- âœ… æ–°å¢ `get_client_status()` æ–¹æ³•
- âœ… æ–°å¢ `cleanup()` æ–¹æ³•ï¼ˆæ›¿ä»£ `clear_all_tools`ï¼‰
- âœ… é…ç½®è·¯å¾„ä½¿ç”¨ `get_resource_path()`

**ä»£ç è¡Œæ•°:**
- ä¼˜åŒ–å‰: 128è¡Œ
- ä¼˜åŒ–å: 180è¡Œï¼ˆå¢åŠ äº†æ–‡æ¡£å’ŒåŠŸèƒ½ï¼‰

### 2. fastmcp_client.py

**ä¸»è¦ä¿®æ”¹:**
- âœ… æ·»åŠ  `name` å‚æ•°ï¼ˆç”¨äºæ—¥å¿—æ ‡è¯†ï¼‰
- âœ… æ‹†åˆ† `init_client()` ä¸ºå¤šä¸ªå­æ–¹æ³•
- âœ… å®Œæ•´çš„ç±»å‹æç¤º
- âœ… è¯¦ç»†çš„æ–‡æ¡£å­—ç¬¦ä¸²
- âœ… ä¼˜åŒ–çš„æ—¥å¿—è¾“å‡º
- âœ… æ”¹è¿›çš„é”™è¯¯å¤„ç†
- âœ… æ–°å¢ `get_status()` æ–¹æ³•
- âœ… æ–°å¢ `_get_tool_name()` è¾…åŠ©æ–¹æ³•
- âœ… ä¼˜åŒ– npx æ¡¥æ¥è„šæœ¬åˆ›å»º

**ä»£ç è¡Œæ•°:**
- ä¼˜åŒ–å‰: 266è¡Œ
- ä¼˜åŒ–å: 350è¡Œï¼ˆå¢åŠ äº†æ–‡æ¡£å’ŒåŠŸèƒ½ï¼‰

### 3. æ–°å¢æ–‡ä»¶

- âœ… `app/ai/mcp/README.md` - å®Œæ•´ä½¿ç”¨æ–‡æ¡£
- âœ… `app/ai/mcp/ä¼˜åŒ–æ€»ç»“.md` - æœ¬æ–‡æ¡£

## ğŸ¯ ä½¿ç”¨å»ºè®®

### 1. å¼€å‘è°ƒè¯•

```python
# å¯ç”¨è¯¦ç»†æ—¥å¿—
from loguru import logger

logger.add(
    "mcp_debug.log", 
    level="DEBUG",
    filter=lambda r: "MCP" in r["extra"].get("tag", "")
)
```

### 2. ç”Ÿäº§ç¯å¢ƒ

```python
# åªè®°å½•é‡è¦ä¿¡æ¯
logger.add(
    "mcp_info.log",
    level="INFO",
    filter=lambda r: "MCP" in r["extra"].get("tag", "")
)
```

### 3. ç›‘æ§å®¢æˆ·ç«¯çŠ¶æ€

```python
# å®šæœŸæ£€æŸ¥å®¢æˆ·ç«¯çŠ¶æ€
async def monitor_mcp_clients():
    while True:
        status = manager.get_client_status()
        logger.info(f"MCPçŠ¶æ€: {status}")
        await asyncio.sleep(60)  # æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
```

## ğŸ”„ åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸï¼ˆ1-2å‘¨ï¼‰

1. âœ… æ·»åŠ å•å…ƒæµ‹è¯•
2. âœ… æ·»åŠ æ€§èƒ½ç›‘æ§ï¼ˆå·¥å…·è°ƒç”¨è€—æ—¶ï¼‰
3. âœ… æ”¯æŒå·¥å…·è°ƒç”¨é‡è¯•æœºåˆ¶
4. âœ… æ·»åŠ å·¥å…·è°ƒç”¨ç¼“å­˜

### ä¸­æœŸï¼ˆ1-2æœˆï¼‰

1. âœ… æ”¯æŒåŠ¨æ€åŠ è½½/å¸è½½MCPæœåŠ¡
2. âœ… æ·»åŠ å·¥å…·è°ƒç”¨é™æµ
3. âœ… æ”¯æŒå·¥å…·è°ƒç”¨æƒé™æ§åˆ¶
4. âœ… æ·»åŠ å·¥å…·è°ƒç”¨ç»Ÿè®¡å’Œåˆ†æ

### é•¿æœŸï¼ˆ3-6æœˆï¼‰

1. âœ… æ”¯æŒMCPæœåŠ¡è‡ªåŠ¨å‘ç°
2. âœ… æ·»åŠ å·¥å…·è°ƒç”¨å¯è§†åŒ–ç•Œé¢
3. âœ… æ”¯æŒåˆ†å¸ƒå¼MCPæœåŠ¡
4. âœ… é›†æˆæ›´å¤šMCPç”Ÿæ€å·¥å…·

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [MCPå®¢æˆ·ç«¯ä½¿ç”¨æ–‡æ¡£](./README.md)
- [AIæ¨¡å—æ€»ä½“æ–‡æ¡£](../doc/README.md)
- [FastMCPå®˜æ–¹æ–‡æ¡£](https://github.com/jlowin/fastmcp)

---

**ä¼˜åŒ–å®Œæˆæ—¶é—´**: 2025-12-29  
**ä¼˜åŒ–äººå‘˜**: AI Assistant  
**ä»£ç è´¨é‡**: â­â­â­â­â­  
**æµ‹è¯•çŠ¶æ€**: âœ… æ— Linteré”™è¯¯

